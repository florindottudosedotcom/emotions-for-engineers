<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Course Creator</title>
    <script src="libs/webllm.js" defer></script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f9f9f9; }
        h1, h2, h3 { color: #2c3e50; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .instructions { background-color: #eaf5ff; border-left: 4px solid #3498db; padding: 1rem; margin-bottom: 2rem; border-radius: 4px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 1rem; }
        textarea { min-height: 100px; resize: vertical; }
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        legend { font-weight: bold; padding: 0 0.5rem; }
        .lang-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .lang-item { display: flex; align-items: center; }
        input[type="checkbox"] { margin-right: 0.5rem; }
        .chapter { border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; background-color: #fafafa; }
        .chapter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 1rem; }
        .btn-primary { background-color: #3498db; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #2ecc71; }
        .btn-secondary:hover { background-color: #27ae60; }
        .btn-danger { background-color: #e74c3c; padding: 0.25rem 0.75rem; }
        .btn-danger:hover { background-color: #c0392b; }
        #download-section { margin-top: 2rem; padding: 1rem; background-color: #f0fff4; border: 1px solid #2ecc71; border-radius: 4px; display: none; }
        .input-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .input-group input, .input-group textarea { flex-grow: 1; margin-bottom: 0 !important; }
        .btn-ai { padding: 0.5rem 1rem; }
        .ai-assistant { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin-top: 1rem; }
        .ai-assistant h4 { margin-top: 0; }
        #ai-status { margin: 1rem 0; padding: 1rem; background-color: #fefae0; border: 1px solid #f0ad4e; border-radius: 4px; white-space: pre-wrap; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Universal Course Creator</h1>
        <div id="ai-status"></div>

        <div class="instructions">
            <h3>How to Use This Tool</h3>
            <ol>
                <li>Fill out the form below with your course details. English is the primary language.</li>
                <li>Use the "AI" buttons to generate content for the course name, description, and chapters.</li>
                <li>Click "Generate Course Files". This will create a <strong>.zip</strong> file containing all the necessary folders and files for your new course.</li>
                <li>Extract the contents of the downloaded .zip file into the <strong>`docs/`</strong> directory of your project.</li>
                <li>Commit and push the changes and create a pull request on main. Upon merging, the workflow generates the pages for the newly added course. </li>
            </ol>
        </div>

        <form id="course-form">
            <h2>Course Details</h2>
            <label for="course-name">Course Name</label>
            <div class="input-group">
                <input type="text" id="course-name" placeholder="e.g., Introduction to Python" required>
                <button type="button" id="generate-name-btn" class="btn btn-secondary btn-ai">AI</button>
            </div>

            <label for="course-desc">Course Description (for main landing page)</label>
            <div class="input-group">
                <textarea id="course-desc" placeholder="A short, exciting description for your new course." required></textarea>
                <button type="button" id="generate-desc-btn" class="btn btn-secondary btn-ai">AI</button>
            </div>

            <h2>Chapters</h2>
            <div id="chapters-container">
                <!-- Chapters will be dynamically added here -->
            </div>
            <button type="button" id="add-chapter" class="btn btn-secondary">Add Chapter</button>

            <fieldset style="margin-top: 2rem;">
                <legend>Course Languages</legend>
                <div class="lang-grid">
                    <div class="lang-item" title="English">
                        <input type="checkbox" id="lang-en" value="en" data-name="English" checked>
                        <img src="https://flagcdn.com/us.svg" alt="USA Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-en" style="flex-grow: 1;">‚≠ê English</label>
                    </div>
                    <div class="lang-item" title="German">
                        <input type="checkbox" id="lang-de" value="de" data-name="German">
                        <img src="https://flagcdn.com/de.svg" alt="German Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-de" style="flex-grow: 1;">German</label>
                    </div>
                    <div class="lang-item" title="Mandarin Chinese">
                        <input type="checkbox" id="lang-zh" value="zh" data-name="Mandarin Chinese">
                        <img src="https://flagcdn.com/cn.svg" alt="Chinese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-zh" style="flex-grow: 1;">Mandarin Chinese</label>
                    </div>
                    <div class="lang-item" title="Spanish">
                        <input type="checkbox" id="lang-es" value="es" data-name="Spanish">
                        <img src="https://flagcdn.com/es.svg" alt="Spanish Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-es" style="flex-grow: 1;">Spanish</label>
                    </div>
                    <div class="lang-item" title="Hindi">
                        <input type="checkbox" id="lang-hi" value="hi" data-name="Hindi">
                        <img src="https://flagcdn.com/in.svg" alt="Indian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-hi" style="flex-grow: 1;">Hindi</label>
                    </div>
                    <div class="lang-item" title="Portuguese">
                        <input type="checkbox" id="lang-pt" value="pt" data-name="Portuguese">
                        <img src="https://flagcdn.com/pt.svg" alt="Portuguese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-pt" style="flex-grow: 1;">Portuguese</label>
                    </div>
                    <div class="lang-item" title="Russian">
                        <input type="checkbox" id="lang-ru" value="ru" data-name="Russian">
                        <img src="https://flagcdn.com/ru.svg" alt="Russian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ru" style="flex-grow: 1;">Russian</label>
                    </div>
                    <div class="lang-item" title="Japanese">
                        <input type="checkbox" id="lang-ja" value="ja" data-name="Japanese">
                        <img src="https://flagcdn.com/jp.svg" alt="Japanese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ja" style="flex-grow: 1;">Japanese</label>
                    </div>
                    <div class="lang-item" title="French">
                        <input type="checkbox" id="lang-fr" value="fr" data-name="French">
                        <img src="https://flagcdn.com/fr.svg" alt="French Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-fr" style="flex-grow: 1;">French</label>
                    </div>
                    <div class="lang-item" title="Italian">
                        <input type="checkbox" id="lang-it" value="it" data-name="Italian">
                        <img src="https://flagcdn.com/it.svg" alt="Italian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-it" style="flex-grow: 1;">Italian</label>
                    </div>
                    <div class="lang-item" title="Romanian">
                        <input type="checkbox" id="lang-ro" value="ro" data-name="Romanian">
                        <img src="https://flagcdn.com/ro.svg" alt="Romanian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ro" style="flex-grow: 1;">Romanian</label>
                    </div>
                </div>
            </fieldset>

            <hr style="margin: 2rem 0;">

            <button type="submit" class="btn btn-primary">Generate Course Files</button>
        </form>

        <div id="download-section">
            <h3>Downloads</h3>
            <p>Your files have been generated. Download them below.</p>
            <a id="download-zip" class="btn btn-primary">Download Course Files (.zip)</a>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Main Application Logic -->
    <script type="module">
        import * as webllm from './libs/webllm.js';

        const courseForm = document.getElementById('course-form');
            const chaptersContainer = document.getElementById('chapters-container');
            const addChapterBtn = document.getElementById('add-chapter');
            const downloadSection = document.getElementById('download-section');
            const downloadZipLink = document.getElementById('download-zip');
            const aiStatus = document.getElementById('ai-status');
            const courseNameInput = document.getElementById('course-name');
            const courseDescTextarea = document.getElementById('course-desc');
            const generateNameBtn = document.getElementById('generate-name-btn');
            const generateDescBtn = document.getElementById('generate-desc-btn');

            let chapterCount = 0;
            const editorInstances = {};
            let engine;

            async function init() {
                aiStatus.style.display = 'block';
                aiStatus.innerText = "Loading AI model (this may take a while, please be patient)...\n";
                try {
                    engine = await webllm.CreateMLCEngine("Llama-3-8B-Instruct-q4f32_1-MLC", {
                        initProgressCallback: (report) => {
                            aiStatus.innerText = report.text;
                        }
                    });
                    aiStatus.innerText += "\n‚úÖ AI Model loaded! You can now use the AI generation features.";
                } catch (err) {
                    aiStatus.innerText = "Error loading AI model: \n" + err.message;
                    console.error(err);
                }
            }

            async function generate(prompt, target) {
                if (!engine) {
                    alert("AI engine is not ready yet. Please wait for the model to load.");
                    return;
                }

                const thinkingMessage = "ü§ñ Generating content...";
                if (target.exec) { // ToastUI Editor
                    target.setMarkdown(thinkingMessage);
                } else { // Standard input/textarea
                    target.value = thinkingMessage;
                }

                try {
                    const reply = await engine.chat.completions.create({
                        messages: [{ role: "user", content: prompt }],
                        stream: true
                    });

                    let firstChunk = true;
                    for await (const chunk of reply) {
                        const delta = chunk.choices[0]?.delta?.content || "";
                        if (firstChunk) {
                            if (target.exec) {
                                target.setMarkdown(delta);
                            } else {
                                target.value = delta;
                            }
                            firstChunk = false;
                        } else {
                            if (target.exec) {
                                target.insertText(delta);
                            } else {
                                target.value += delta;
                            }
                        }
                    }
                } catch (err) {
                    const errorMessage = "\n\nError: " + err.message;
                    if (target.exec) {
                        target.insertText(errorMessage);
                    } else {
                        target.value += errorMessage;
                    }
                    console.error(err);
                }
            }

            async function translate(textToTranslate, targetLangName) {
                if (!engine) {
                    throw new Error("AI engine is not ready for translation.");
                }

                const prompt = `Translate the following text to ${targetLangName}. Only provide the raw, translated text. Do not include any explanations, introductory phrases, or quotation marks. The text to translate is:\n\n"${textToTranslate}"`;

                try {
                    const reply = await engine.chat.completions.create({
                        messages: [{ role: "user", content: prompt }],
                    });
                    return reply.choices[0]?.message?.content.trim() || "";
                } catch (err) {
                    console.error(`Translation to ${targetLangName} failed:`, err);
                    // Return original text as a fallback
                    return textToTranslate;
                }
            }

            init();

            generateNameBtn.addEventListener('click', () => {
                const topic = prompt("Enter a topic for the course name:", "Introduction to Artificial Intelligence");
                if (topic) {
                    const promptText = `Generate a short, catchy course name about "${topic}". The name should be concise and suitable for a course title. Do not add any extra text or quotation marks, just the name itself.`;
                    generate(promptText, courseNameInput);
                }
            });

            generateDescBtn.addEventListener('click', () => {
                const courseName = courseNameInput.value || "this course";
                const userPrompt = prompt(`Enter a prompt to generate a description for "${courseName}":`, `Write an exciting, short description for a course named "${courseName}". The description should be engaging and informative for a main landing page.`);
                if (userPrompt) {
                    generate(userPrompt, courseDescTextarea);
                }
            });

            chaptersContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('generate-content-btn')) {
                    const chapterId = e.target.dataset.chapterId;
                    const promptTextarea = document.getElementById(`ai-prompt-${chapterId}`);
                    const prompt = promptTextarea.value;
                    const editor = editorInstances[chapterId];

                    if (prompt && editor) {
                        generate(prompt, editor);
                    } else if (!prompt) {
                        alert("Please enter a prompt for the AI assistant.");
                    }
                }
            });

            const slugify = (text) => {
                return text.toString().toLowerCase()
                    .replace(/\s+/g, '-')           // Replace spaces with -
                    .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                    .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                    .replace(/^-+/, '')             // Trim - from start of text
                    .replace(/-+$/, '');            // Trim - from end of text
            };

            const addChapter = () => {
                chapterCount++;
                const chapterId = chapterCount;
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter';
                chapterDiv.id = `chapter-${chapterId}`;
                chapterDiv.innerHTML = `
                    <div class="chapter-header">
                        <h3>Chapter ${chapterId}</h3>
                        <button type="button" class="btn btn-danger remove-chapter-btn" data-chapter-id="${chapterId}">Remove</button>
                    </div>
                    <label for="chapter-title-${chapterId}">Chapter Title</label>
                    <input type="text" id="chapter-title-${chapterId}" class="chapter-title" placeholder="e.g., Getting Started" required>
                    <label for="editor-${chapterId}">Chapter Content</label>
                    <div id="editor-${chapterId}" class="chapter-editor"></div>
                    <div class="ai-assistant">
                        <h4>AI Assistant</h4>
                        <label for="ai-prompt-${chapterId}">Prompt</label>
                        <textarea id="ai-prompt-${chapterId}" placeholder="e.g., 'Explain the concept of...' or 'Create a quiz about...'"></textarea>
                        <button type="button" class="btn btn-secondary generate-content-btn" data-chapter-id="${chapterId}">Generate Content</button>
                    </div>
                `;
                chaptersContainer.appendChild(chapterDiv);

                const editor = new toastui.Editor({
                    el: document.querySelector(`#editor-${chapterId}`),
                    height: '250px',
                    initialEditType: 'wysiwyg',
                    previewStyle: 'vertical',
                    toolbarItems: [
                        ['heading', 'bold', 'italic', 'strike'],
                        ['hr', 'quote'],
                        ['ul', 'ol', 'task', 'indent', 'outdent'],
                        ['table', 'image', 'link'],
                        ['code', 'codeblock'],
                        ['scrollSync'],
                    ]
                });
                editorInstances[chapterId] = editor;

                chapterDiv.querySelector('.remove-chapter-btn').addEventListener('click', () => {
                    const id = chapterDiv.querySelector('.remove-chapter-btn').dataset.chapterId;
                    delete editorInstances[id];
                    document.getElementById(`chapter-${id}`).remove();
                });
            };

            addChapterBtn.addEventListener('click', addChapter);

            courseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = courseForm.querySelector('button[type="submit"]');

                try {
                    submitBtn.disabled = true;
                    aiStatus.style.display = 'block';
                    aiStatus.innerText = 'Gathering course content...';

                    const courseName = document.getElementById('course-name').value;
                const courseDesc = document.getElementById('course-desc').value;
                const selectedLangs = Array.from(document.querySelectorAll('.lang-grid input[type="checkbox"]:checked')).map(cb => cb.value);

                if (selectedLangs.length === 0) {
                    alert('Please select at least one language.');
                    return;
                }

                const courseSlug = slugify(courseName);
                if (!courseSlug) {
                    alert('Please enter a valid course name.');
                    return;
                }

                const chapters = [];
                document.querySelectorAll('.chapter').forEach((chapterDiv, index) => {
                    const title = chapterDiv.querySelector('.chapter-title').value;
                    const chapterId = chapterDiv.id.split('-')[1];
                    const editor = editorInstances[chapterId];
                    const content = editor.getMarkdown();
                    const chapterSlug = slugify(title);
                    const chapterNumber = String(index + 1).padStart(2, '0');
                    chapters.push({ title, content, slug: chapterSlug, number: chapterNumber });
                });

                if (chapters.length === 0) {
                    alert('Please add at least one chapter.');
                    return;
                }

                const zip = new JSZip();
                const courseFolder = zip.folder(courseSlug);

                // Create the assets folder once.
                courseFolder.folder('assets');

                const langCheckboxes = Object.fromEntries(
                    Array.from(document.querySelectorAll('.lang-item input[type="checkbox"]'))
                        .map(cb => [cb.value, cb])
                );

                const nonEnglishLangs = selectedLangs.filter(l => l !== 'en');
                const progress = {
                    completed: 0,
                    total: nonEnglishLangs.length * (1 + 1 + chapters.length * 2) // course name, desc, and for each chapter: title, content
                };

                if (progress.total > 0) {
                    aiStatus.innerText = `Starting translation of ${progress.total} items across ${nonEnglishLangs.length} language(s)...`;
                }

                // Process all selected languages in parallel for faster translation and file generation.
                const processingPromises = selectedLangs.map(async (lang) => {
                    const langName = langCheckboxes[lang]?.dataset.name;
                    if (!langName) {
                        console.warn(`Could not find language details for code: ${lang}. Skipping this language.`);
                        return; // Skip this iteration
                    }

                    let translatedCourseName = courseName;
                    let translatedCourseDesc = courseDesc;
                    let translatedChapters = chapters;
                    const isPrimaryLang = lang === 'en';

                    if (!isPrimaryLang) {
                        const updateProgress = () => {
                            progress.completed++;
                            aiStatus.innerText = `Translating... ${progress.completed} of ${progress.total} items completed.`;
                        };

                        updateProgress();
                        translatedCourseName = await translate(courseName, langName);

                        updateProgress();
                        translatedCourseDesc = await translate(courseDesc, langName);

                        const newChapters = [];
                        for (let i = 0; i < chapters.length; i++) {
                            const chapter = chapters[i];

                            updateProgress();
                            const translatedTitle = await translate(chapter.title, langName);

                            updateProgress();
                            const translatedContent = await translate(chapter.content, langName);


                            newChapters.push({
                                ...chapter,
                                title: translatedTitle,
                                content: translatedContent
                            });
                        }
                        translatedChapters = newChapters;
                    }

                    // Create index file
                    const indexContent = `---\ndescription: ${translatedCourseDesc}\n---\n\n# ${translatedCourseName}`;
                    courseFolder.file(`index.${lang}.md`, indexContent);

                    // Create chapter files
                    for (const chapter of translatedChapters) {
                        const chapterFilename = `${chapter.number}-${chapter.slug}.${lang}.md`;
                        const chapterContent = `# ${chapter.title}\n\n${chapter.content}`;
                        courseFolder.file(chapterFilename, chapterContent);
                    }
                });

                await Promise.all(processingPromises);

                aiStatus.innerText = 'All translations complete. Now packaging your course files into a .zip file...';
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                downloadZipLink.href = URL.createObjectURL(zipBlob);
                downloadZipLink.download = `${courseSlug}.zip`;
                downloadSection.style.display = 'block';

                alert('Success! Your course files have been packaged. Click the download link that has appeared.');
                } finally {
                    submitBtn.disabled = false;
                    aiStatus.innerText += '\n\nAll tasks finished.';
                }
            });

            // Add the first chapter on page load
            addChapter();
    </script>

</body>
</html>
