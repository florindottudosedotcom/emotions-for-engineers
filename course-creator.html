<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Course Creator</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f9f9f9; }
        h1, h2, h3 { color: #2c3e50; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .instructions { background-color: #eaf5ff; border-left: 4px solid #3498db; padding: 1rem; margin-bottom: 2rem; border-radius: 4px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 1rem; }
        textarea { min-height: 100px; resize: vertical; }
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        legend { font-weight: bold; padding: 0 0.5rem; }
        .lang-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .lang-item { display: flex; align-items: center; }
        input[type="checkbox"] { margin-right: 0.5rem; }
        .chapter { border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; background-color: #fafafa; }
        .chapter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 1rem; }
        .btn-primary { background-color: #3498db; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #2ecc71; }
        .btn-secondary:hover { background-color: #27ae60; }
        .btn-danger { background-color: #e74c3c; padding: 0.25rem 0.75rem; }
        .btn-danger:hover { background-color: #c0392b; }
        #download-section { margin-top: 2rem; padding: 1rem; background-color: #f0fff4; border: 1px solid #2ecc71; border-radius: 4px; display: none; }
        .input-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .input-group input, .input-group textarea { flex-grow: 1; margin-bottom: 0 !important; }
        .btn-ai { padding: 0.5rem 1rem; }
        .ai-assistant { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin-top: 1rem; }
        .ai-assistant h4 { margin-top: 0; }
        #ai-status { margin: 1rem 0; padding: 1rem; background-color: #fefae0; border: 1px solid #f0ad4e; border-radius: 4px; white-space: pre-wrap; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Universal Course Creator</h1>
        <div id="ai-status" style="white-space: pre-wrap; display: none;"></div>

        <div class="instructions">
            <h3>How to Use This Tool</h3>
            <ol>
                <li>Make sure Ollama is running on your computer and you have downloaded a model (e.g., `ollama pull llama3`).</li>
                <li>Enter a topic for your course below and select the number of chapters.</li>
                <li>Click "Generate Course". The AI will populate the course details and chapters for you.</li>
                <li>Review and edit the generated content as needed.</li>
                <li>Select the languages you want to translate the course into.</li>
                <li>Click "Generate Course Files". This will create a .zip file with all the markdown files.</li>
            </ol>
        </div>

        <fieldset>
            <legend>Ollama Configuration</legend>
            <div class="input-group">
                <label for="ollama-model" style="flex-shrink: 0; margin-bottom: 0;">Ollama Model:</label>
                <select id="ollama-model" style="margin-bottom: 0;"></select>
                <button type="button" id="refresh-models-btn" class="btn btn-secondary">Refresh List</button>
            </div>
            <div id="ollama-status" style="margin-top: 0.5rem; font-weight: bold;"></div>
        </fieldset>

        <fieldset>
            <legend>Master AI Assistant</legend>
            <label for="master-prompt">Course Prompt</label>
            <textarea id="master-prompt" placeholder="e.g., 'Create a comprehensive course about the history of ancient Rome, from its founding to the fall of the Western Empire.'"></textarea>
            <div class="input-group">
                <label for="num-chapters" style="flex-shrink: 0; margin-bottom: 0;">Number of Chapters:</label>
                <select id="num-chapters" style="margin-bottom: 0;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <button type="button" id="generate-course-btn" class="btn btn-secondary" style="margin-left: 1rem;">Generate Entire Course</button>
            </div>
        </fieldset>

        <hr style="margin: 2rem 0;">

        <form id="course-form">
            <h2>Course Details</h2>
            <label for="course-name">Course Name</label>
            <input type="text" id="course-name" placeholder="Generated by AI" required>

            <label for="course-desc">Course Description (for main landing page)</label>
            <textarea id="course-desc" placeholder="Generated by AI" required></textarea>

            <h2>Chapters</h2>
            <div id="chapters-container">
                <!-- Chapters will be dynamically added here by the master AI or manually -->
            </div>
            <button type="button" id="add-chapter" class="btn btn-secondary">Add Chapter Manually</button>

            <fieldset style="margin-top: 2rem;">
                <legend>Course Languages</legend>
                <div class="lang-grid">
                    <div class="lang-item" title="English">
                        <input type="checkbox" id="lang-en" value="en" data-name="English" checked>
                        <img src="https://flagcdn.com/us.svg" alt="USA Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-en" style="flex-grow: 1;">⭐ English</label>
                    </div>
                    <div class="lang-item" title="German">
                        <input type="checkbox" id="lang-de" value="de" data-name="German">
                        <img src="https://flagcdn.com/de.svg" alt="German Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-de" style="flex-grow: 1;">German</label>
                    </div>
                    <div class="lang-item" title="Mandarin Chinese">
                        <input type="checkbox" id="lang-zh" value="zh" data-name="Mandarin Chinese">
                        <img src="https://flagcdn.com/cn.svg" alt="Chinese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-zh" style="flex-grow: 1;">Mandarin Chinese</label>
                    </div>
                    <div class="lang-item" title="Spanish">
                        <input type="checkbox" id="lang-es" value="es" data-name="Spanish">
                        <img src="https://flagcdn.com/es.svg" alt="Spanish Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-es" style="flex-grow: 1;">Spanish</label>
                    </div>
                    <div class="lang-item" title="Hindi">
                        <input type="checkbox" id="lang-hi" value="hi" data-name="Hindi">
                        <img src="https://flagcdn.com/in.svg" alt="Indian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-hi" style="flex-grow: 1;">Hindi</label>
                    </div>
                    <div class="lang-item" title="Portuguese">
                        <input type="checkbox" id="lang-pt" value="pt" data-name="Portuguese">
                        <img src="https://flagcdn.com/pt.svg" alt="Portuguese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-pt" style="flex-grow: 1;">Portuguese</label>
                    </div>
                    <div class="lang-item" title="Russian">
                        <input type="checkbox" id="lang-ru" value="ru" data-name="Russian">
                        <img src="https://flagcdn.com/ru.svg" alt="Russian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ru" style="flex-grow: 1;">Russian</label>
                    </div>
                    <div class="lang-item" title="Japanese">
                        <input type="checkbox" id="lang-ja" value="ja" data-name="Japanese">
                        <img src="https://flagcdn.com/jp.svg" alt="Japanese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ja" style="flex-grow: 1;">Japanese</label>
                    </div>
                    <div class="lang-item" title="French">
                        <input type="checkbox" id="lang-fr" value="fr" data-name="French">
                        <img src="https://flagcdn.com/fr.svg" alt="French Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-fr" style="flex-grow: 1;">French</label>
                    </div>
                    <div class="lang-item" title="Italian">
                        <input type="checkbox" id="lang-it" value="it" data-name="Italian">
                        <img src="https://flagcdn.com/it.svg" alt="Italian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-it" style="flex-grow: 1;">Italian</label>
                    </div>
                    <div class="lang-item" title="Romanian">
                        <input type="checkbox" id="lang-ro" value="ro" data-name="Romanian">
                        <img src="https://flagcdn.com/ro.svg" alt="Romanian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ro" style="flex-grow: 1;">Romanian</label>
                    </div>
                </div>
            </fieldset>

            <hr style="margin: 2rem 0;">

            <button type="submit" class="btn btn-primary">Generate Course Files</button>
        </form>

        <div id="download-section">
            <h3>Downloads</h3>
            <p>Your files have been generated. Download them below.</p>
            <a id="download-zip" class="btn btn-primary">Download Course Files (.zip)</a>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Main Application Logic -->
    <script type="module">
        // DOM Elements
        const courseForm = document.getElementById('course-form');
        const chaptersContainer = document.getElementById('chapters-container');
        const addChapterBtn = document.getElementById('add-chapter');
        const downloadSection = document.getElementById('download-section');
        const downloadZipLink = document.getElementById('download-zip');
        const aiStatus = document.getElementById('ai-status');
        const courseNameInput = document.getElementById('course-name');
        const courseDescTextarea = document.getElementById('course-desc');

        // Ollama UI
        const ollamaModelSelect = document.getElementById('ollama-model');
        const refreshModelsBtn = document.getElementById('refresh-models-btn');
        const ollamaStatus = document.getElementById('ollama-status');

        // Master AI UI
        const masterPromptTextarea = document.getElementById('master-prompt');
        const numChaptersSelect = document.getElementById('num-chapters');
        const generateCourseBtn = document.getElementById('generate-course-btn');

        let chapterCount = 0;
        const editorInstances = {};

        // --- Ollama Functions ---

        async function loadOllamaModels() {
            ollamaStatus.textContent = 'Loading models...';
            ollamaModelSelect.innerHTML = ''; // Clear existing options
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                if (!response.ok) {
                    throw new Error(`Ollama server responded with status: ${response.status}`);
                }
                const data = await response.json();
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.name;
                        ollamaModelSelect.appendChild(option);
                    });
                    ollamaStatus.textContent = `✅ Found ${data.models.length} model(s).`;
                    ollamaStatus.style.color = 'green';
                } else {
                    ollamaStatus.textContent = '⚠️ No models found. Please pull a model, e.g., `ollama pull llama3`.';
                    ollamaStatus.style.color = 'orange';
                }
            } catch (err) {
                ollamaStatus.textContent = `❌ Connection failed. Make sure Ollama is running. Error: ${err.message}`;
                ollamaStatus.style.color = 'red';
            }
        }

        async function generateCourse() {
            const userPrompt = masterPromptTextarea.value;
            const numChapters = numChaptersSelect.value;
            const model = ollamaModelSelect.value;

            if (!model) {
                alert('Please select an Ollama model first. If the list is empty, make sure Ollama is running and click "Refresh List".');
                return;
            }
            if (!userPrompt) {
                alert('Please enter a prompt for the course.');
                return;
            }

            aiStatus.style.display = 'block';
            aiStatus.textContent = 'Generating course structure with Ollama... This may take a moment.';

            const systemPrompt = `You are an expert course creator. A user wants to create a course.
User's prompt: "${userPrompt}"
Number of chapters: ${numChapters}

Your task is to generate a complete course structure based on this prompt.
You MUST respond with ONLY a single, valid JSON object. Do not include any other text, explanations, or markdown formatting.
The JSON object must have the following structure:
{
  "course_title": "A creative and engaging title for the course",
  "course_description": "A short, compelling description for the course landing page",
  "chapters": [
    {
      "title": "Title of Chapter 1",
      "content": "The full content of Chapter 1 as a single string of Markdown text."
    },
    {
      "title": "Title of Chapter 2",
      "content": "The full content of Chapter 2 as a single string of Markdown text."
    }
  ]
}
Ensure the "chapters" array contains exactly ${numChapters} objects.`;

            try {
                const response = await fetch('http://localhost:11434/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: systemPrompt }],
                        stream: false,
                        format: 'json'
                    }),
                });

                if (!response.ok) {
                    throw new Error(`Ollama API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const content = data.message.content;
                aiStatus.textContent = "AI generation complete. Parsing response and populating form...";
                populateFormWithAIResponse(content);
            } catch (err) {
                aiStatus.textContent = `Error generating course: ${err.message}`;
                console.error(err);
            }
        }

        function populateFormWithAIResponse(jsonString) {
            try {
                const courseData = JSON.parse(jsonString);

                if (!courseData.course_title || !courseData.course_description || !courseData.chapters) {
                    throw new Error("The AI response is missing required fields (course_title, course_description, chapters).");
                }

                courseNameInput.value = courseData.course_title;
                courseDescTextarea.value = courseData.course_description;

                // Clear existing chapters
                chaptersContainer.innerHTML = '';
                Object.keys(editorInstances).forEach(key => delete editorInstances[key]);
                chapterCount = 0;

                // Add new chapters from AI response
                courseData.chapters.forEach(chapterData => {
                    addChapter(); // This creates the chapter div and editor instance
                    const newChapterId = chapterCount;
                    const titleInput = document.getElementById(`chapter-title-${newChapterId}`);
                    const editor = editorInstances[newChapterId];

                    if (titleInput) {
                        titleInput.value = chapterData.title;
                    }
                    if (editor) {
                        editor.setMarkdown(chapterData.content);
                    }
                });

                aiStatus.textContent = "✅ Course content has been successfully populated!";
                setTimeout(() => { aiStatus.style.display = 'none'; }, 5000);


            } catch (err) {
                aiStatus.textContent = `Error parsing AI response. The response was not valid JSON or was missing fields. Please try generating again.\n\nError: ${err.message}`;
                console.error("Invalid JSON response from Ollama:", jsonString);
            }
        }

        // --- Event Listeners ---
        refreshModelsBtn.addEventListener('click', loadOllamaModels);
        generateCourseBtn.addEventListener('click', generateCourse);
        document.addEventListener('DOMContentLoaded', loadOllamaModels);


        // --- Existing Functions (to be refactored) ---

        const slugify = (text) => {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        };

        const addChapter = () => {
            chapterCount++;
            const chapterId = chapterCount;
            const chapterDiv = document.createElement('div');
            chapterDiv.className = 'chapter';
            chapterDiv.id = `chapter-${chapterId}`;
            chapterDiv.innerHTML = `
                <div class="chapter-header">
                    <h3>Chapter ${chapterId}</h3>
                    <button type="button" class="btn btn-danger remove-chapter-btn" data-chapter-id="${chapterId}">Remove</button>
                </div>
                <label for="chapter-title-${chapterId}">Chapter Title</label>
                <input type="text" id="chapter-title-${chapterId}" class="chapter-title" placeholder="e.g., Getting Started" required>
                <label for="editor-${chapterId}">Chapter Content</label>
                <div id="editor-${chapterId}" class="chapter-editor"></div>
            `;
            chaptersContainer.appendChild(chapterDiv);

            const editor = new toastui.Editor({
                el: document.querySelector(`#editor-${chapterId}`),
                height: '250px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                toolbarItems: [
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task', 'indent', 'outdent'],
                    ['table', 'image', 'link'],
                    ['code', 'codeblock'],
                    ['scrollSync'],
                ]
            });
            editorInstances[chapterId] = editor;

            chapterDiv.querySelector('.remove-chapter-btn').addEventListener('click', () => {
                const id = chapterDiv.querySelector('.remove-chapter-btn').dataset.chapterId;
                delete editorInstances[id];
                document.getElementById(`chapter-${id}`).remove();
            });
        };

        addChapterBtn.addEventListener('click', addChapter);

        // Add one chapter by default so the page isn't empty
        addChapter();

        async function translate(textToTranslate, targetLangName) {
            const model = ollamaModelSelect.value;
            if (!model) {
                alert('Cannot translate without a selected Ollama model.');
                return textToTranslate; // Return original text if no model
            }
            const prompt = `Translate the following text to ${targetLangName}. Only provide the raw, translated text. Do not include any explanations, introductory phrases, or quotation marks. The text to translate is:\n\n"${textToTranslate}"`;

            try {
                const response = await fetch('http://localhost:11434/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        stream: false,
                    }),
                });
                if (!response.ok) {
                    throw new Error(`Ollama API request failed with status ${response.status}`);
                }
                const data = await response.json();
                return data.message.content.trim() || textToTranslate;
            } catch (err) {
                console.error(`Translation to ${targetLangName} failed:`, err);
                return textToTranslate; // Return original text as a fallback
            }
        }

        courseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = courseForm.querySelector('button[type="submit"]');

            try {
                submitBtn.disabled = true;
                aiStatus.style.display = 'block';
                aiStatus.textContent = 'Gathering course content...';

                const courseName = courseNameInput.value;
                const courseDesc = courseDescTextarea.value;
                const selectedLangs = Array.from(document.querySelectorAll('.lang-grid input[type="checkbox"]:checked')).map(cb => cb.value);

                if (selectedLangs.length === 0) {
                    alert('Please select at least one language.');
                    return;
                }
                const courseSlug = slugify(courseName);
                if (!courseSlug) {
                    alert('Please enter a valid course name.');
                    return;
                }

                const chapters = [];
                document.querySelectorAll('.chapter').forEach((chapterDiv) => {
                    const chapterId = chapterDiv.id.split('-')[1];
                    const title = document.getElementById(`chapter-title-${chapterId}`).value;
                    const editor = editorInstances[chapterId];
                    const content = editor ? editor.getMarkdown() : '';
                    const chapterSlug = slugify(title);
                    const chapterNumber = String(chapters.length + 1).padStart(2, '0');
                    chapters.push({ title, content, slug: chapterSlug, number: chapterNumber });
                });

                if (chapters.length === 0) {
                    alert('Please add at least one chapter.');
                    return;
                }

                const zip = new JSZip();
                const courseFolder = zip.folder(courseSlug);
                courseFolder.folder('assets');

                const langCheckboxes = Object.fromEntries(
                    Array.from(document.querySelectorAll('.lang-item input[type="checkbox"]'))
                    .map(cb => [cb.value, cb])
                );

                const nonEnglishLangs = selectedLangs.filter(l => l !== 'en');
                const progress = {
                    completed: 0,
                    total: nonEnglishLangs.length * (1 + 1 + chapters.length * 2)
                };

                if (progress.total > 0) {
                    aiStatus.textContent = `Starting translation of ${progress.total} items across ${nonEnglishLangs.length} language(s)...`;
                }

                const processingPromises = selectedLangs.map(async (lang) => {
                    const langName = langCheckboxes[lang]?.dataset.name;
                    if (!langName) return;

                    let translatedCourseName = courseName;
                    let translatedCourseDesc = courseDesc;
                    let translatedChapters = chapters;
                    const isPrimaryLang = lang === 'en';

                    if (!isPrimaryLang) {
                        const updateProgress = () => {
                            progress.completed++;
                            aiStatus.textContent = `Translating... ${progress.completed} of ${progress.total} items completed.`;
                        };

                        translatedCourseName = await translate(courseName, langName);
                        updateProgress();
                        translatedCourseDesc = await translate(courseDesc, langName);
                        updateProgress();

                        const newChapters = [];
                        for (const chapter of chapters) {
                            const translatedTitle = await translate(chapter.title, langName);
                            updateProgress();
                            const translatedContent = await translate(chapter.content, langName);
                            updateProgress();
                            newChapters.push({ ...chapter, title: translatedTitle, content: translatedContent });
                        }
                        translatedChapters = newChapters;
                    }

                    const indexContent = `---\ndescription: ${translatedCourseDesc}\n---\n\n# ${translatedCourseName}`;
                    courseFolder.file(`index.${lang}.md`, indexContent);

                    for (const chapter of translatedChapters) {
                        const chapterFilename = `${chapter.number}-${chapter.slug}.${lang}.md`;
                        const chapterContent = `# ${chapter.title}\n\n${chapter.content}`;
                        courseFolder.file(chapterFilename, chapterContent);
                    }
                });

                await Promise.all(processingPromises);

                aiStatus.textContent = 'All translations complete. Now packaging your course files into a .zip file...';
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                downloadZipLink.href = URL.createObjectURL(zipBlob);
                downloadZipLink.download = `${courseSlug}.zip`;
                downloadSection.style.display = 'block';
                aiStatus.textContent = '✅ Success! Your course files have been packaged. Click the download link that has appeared.';

            } finally {
                submitBtn.disabled = false;
            }
        });

    </script>

</body>
</html>
