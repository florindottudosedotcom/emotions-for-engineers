<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Course Creator</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f9f9f9; }
        h1, h2, h3 { color: #2c3e50; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .instructions { background-color: #eaf5ff; border-left: 4px solid #3498db; padding: 1rem; margin-bottom: 2rem; border-radius: 4px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 1rem; }
        textarea { min-height: 100px; resize: vertical; }
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        legend { font-weight: bold; padding: 0 0.5rem; }
        .lang-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .lang-item { display: flex; align-items: center; }
        input[type="checkbox"] { margin-right: 0.5rem; }
        .chapter { border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; background-color: #fafafa; }
        .chapter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 1rem; }
        .btn-primary { background-color: #3498db; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #2ecc71; }
        .btn-secondary:hover { background-color: #27ae60; }
        .btn-danger { background-color: #e74c3c; padding: 0.25rem 0.75rem; }
        .btn-danger:hover { background-color: #c0392b; }
        #download-section { margin-top: 2rem; padding: 1rem; background-color: #f0fff4; border: 1px solid #2ecc71; border-radius: 4px; display: none; }
        .input-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .input-group input, .input-group textarea { flex-grow: 1; margin-bottom: 0 !important; }
        .btn-ai { padding: 0.5rem 1rem; }
        .ai-assistant { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin-top: 1rem; }
        .ai-assistant h4 { margin-top: 0; }
        #ai-status { margin: 1rem 0; padding: 1rem; background-color: #fefae0; border: 1px solid #f0ad4e; border-radius: 4px; white-space: pre-wrap; display: none; }
        .header-container { display: flex; justify-content: space-between; align-items: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 90%; max-width: 500px; }
        .modal-content.hidden { display: none; }
        .modal-overlay.visible { display: flex; }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Cloud API Settings</h2>
            <p>Enter your API keys for cloud providers. Keys are saved in your browser's local storage and are not sent anywhere else.</p>
            <form id="api-keys-form">
                <label for="openai-api-key">OpenAI API Key</label>
                <input type="password" id="openai-api-key" placeholder="sk-...">

                <label for="anthropic-api-key">Anthropic API Key</label>
                <input type="password" id="anthropic-api-key" placeholder="sk-ant-...">

                <label for="google-api-key">Google Gemini API Key</label>
                <input type="password" id="google-api-key" placeholder="AIzaSy...">

                <div class="input-group" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Keys</button>
                    <button type="button" id="close-settings-btn" class="btn btn-danger" style="margin-left: auto;">Close</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="header-container">
            <h1>Universal Course Creator</h1>
            <button type="button" id="settings-btn" class="btn btn-secondary">Settings</button>
        </div>
        <div id="ai-status" style="white-space: pre-wrap; display: none;"></div>

        <div class="instructions">
            <h3>How to Use This Tool</h3>
            <ol>
                <li>Make sure Ollama is running on your computer and you have downloaded a model (e.g., `ollama pull llama3`).</li>
                <li>Enter a topic for your course below and select the number of chapters.</li>
                <li>Click "Generate Course". The AI will populate the course details and chapters for you.</li>
                <li>Review and edit the generated content as needed.</li>
                <li>Select the languages you want to translate the course into.</li>
                <li>Click "Generate Course Files". This will create a .zip file with all the markdown files.</li>
            </ol>
        </div>

        <fieldset>
            <legend>AI Provider</legend>
            <div class="input-group">
                <label for="ai-provider-select" style="flex-shrink: 0; margin-bottom: 0;">Provider:</label>
                <select id="ai-provider-select" style="margin-bottom: 0;"></select>
            </div>
            <div class="input-group" id="ai-model-selection-group" style="display: none;">
                <label for="ai-model-select" style="flex-shrink: 0; margin-bottom: 0;">Model:</label>
                <select id="ai-model-select" style="margin-bottom: 0;"></select>
                <button type="button" id="refresh-models-btn" class="btn btn-secondary">Refresh List</button>
            </div>
            <div id="ollama-status" style="margin-top: 0.5rem; font-weight: bold;"></div>
        </fieldset>

        <fieldset>
            <legend>Master AI Assistant</legend>
            <label for="master-prompt">Course Prompt</label>
            <textarea id="master-prompt" placeholder="e.g., 'Create a comprehensive course about the history of ancient Rome, from its founding to the fall of the Western Empire.'"></textarea>
            <div class="input-group">
                <label for="num-chapters" style="flex-shrink: 0; margin-bottom: 0;">Number of Chapters:</label>
                <select id="num-chapters" style="margin-bottom: 0;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <button type="button" id="generate-course-btn" class="btn btn-secondary" style="margin-left: 1rem;">Generate Entire Course</button>
            </div>
        </fieldset>

        <hr style="margin: 2rem 0;">

        <form id="course-form">
            <h2>Course Details</h2>
            <label for="course-name">Course Name</label>
            <input type="text" id="course-name" placeholder="Generated by AI" required>

            <label for="course-desc">Course Description (for main landing page)</label>
            <textarea id="course-desc" placeholder="Generated by AI" required></textarea>

            <h2>Chapters</h2>
            <div id="chapters-container">
                <!-- Chapters will be dynamically added here by the master AI or manually -->
            </div>
            <div class="input-group">
                <button type="button" id="add-chapter" class="btn btn-secondary">Add Chapter Manually</button>
                <button type="button" id="clear-form-btn" class="btn btn-danger" style="margin-left: auto;">Clear Form & Start New</button>
            </div>

            <fieldset style="margin-top: 2rem;">
                <legend>Course Languages</legend>
                <div class="lang-grid">
                    <div class="lang-item" title="English">
                        <input type="checkbox" id="lang-en" value="en" data-name="English" checked>
                        <img src="https://flagcdn.com/us.svg" alt="USA Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-en" style="flex-grow: 1;">‚≠ê English</label>
                    </div>
                    <div class="lang-item" title="German">
                        <input type="checkbox" id="lang-de" value="de" data-name="German">
                        <img src="https://flagcdn.com/de.svg" alt="German Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-de" style="flex-grow: 1;">German</label>
                    </div>
                    <div class="lang-item" title="Mandarin Chinese">
                        <input type="checkbox" id="lang-zh" value="zh" data-name="Mandarin Chinese">
                        <img src="https://flagcdn.com/cn.svg" alt="Chinese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-zh" style="flex-grow: 1;">Mandarin Chinese</label>
                    </div>
                    <div class="lang-item" title="Spanish">
                        <input type="checkbox" id="lang-es" value="es" data-name="Spanish">
                        <img src="https://flagcdn.com/es.svg" alt="Spanish Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-es" style="flex-grow: 1;">Spanish</label>
                    </div>
                    <div class="lang-item" title="Hindi">
                        <input type="checkbox" id="lang-hi" value="hi" data-name="Hindi">
                        <img src="https://flagcdn.com/in.svg" alt="Indian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-hi" style="flex-grow: 1;">Hindi</label>
                    </div>
                    <div class="lang-item" title="Portuguese">
                        <input type="checkbox" id="lang-pt" value="pt" data-name="Portuguese">
                        <img src="https://flagcdn.com/pt.svg" alt="Portuguese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-pt" style="flex-grow: 1;">Portuguese</label>
                    </div>
                    <div class="lang-item" title="Russian">
                        <input type="checkbox" id="lang-ru" value="ru" data-name="Russian">
                        <img src="https://flagcdn.com/ru.svg" alt="Russian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ru" style="flex-grow: 1;">Russian</label>
                    </div>
                    <div class="lang-item" title="Japanese">
                        <input type="checkbox" id="lang-ja" value="ja" data-name="Japanese">
                        <img src="https://flagcdn.com/jp.svg" alt="Japanese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ja" style="flex-grow: 1;">Japanese</label>
                    </div>
                    <div class="lang-item" title="French">
                        <input type="checkbox" id="lang-fr" value="fr" data-name="French">
                        <img src="https://flagcdn.com/fr.svg" alt="French Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-fr" style="flex-grow: 1;">French</label>
                    </div>
                    <div class="lang-item" title="Italian">
                        <input type="checkbox" id="lang-it" value="it" data-name="Italian">
                        <img src="https://flagcdn.com/it.svg" alt="Italian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-it" style="flex-grow: 1;">Italian</label>
                    </div>
                    <div class="lang-item" title="Romanian">
                        <input type="checkbox" id="lang-ro" value="ro" data-name="Romanian">
                        <img src="https://flagcdn.com/ro.svg" alt="Romanian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ro" style="flex-grow: 1;">Romanian</label>
                    </div>
                </div>
            </fieldset>

            <hr style="margin: 2rem 0;">

            <button type="submit" class="btn btn-primary">Generate Course Files</button>
        </form>

        <div id="download-section">
            <h3>Downloads</h3>
            <p>Your files have been generated. Download them below.</p>
            <a id="download-zip" class="btn btn-primary">Download Course Files (.zip)</a>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Main Application Logic -->
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // --- AI Provider State ---
        let AI_PROVIDER = 'ollama'; // 'ollama' or 'webllm'
        let webllmEngine = null;
        const WEBLLM_MODEL_ID = "Phi-3-mini-4k-instruct-q4f16_1-MLC";

        // DOM Elements
        const courseForm = document.getElementById('course-form');
        const chaptersContainer = document.getElementById('chapters-container');
        const addChapterBtn = document.getElementById('add-chapter');
        const downloadSection = document.getElementById('download-section');
        const downloadZipLink = document.getElementById('download-zip');
        const aiStatus = document.getElementById('ai-status');
        const courseNameInput = document.getElementById('course-name');
        const courseDescTextarea = document.getElementById('course-desc');

        // Settings UI
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const apiKeysForm = document.getElementById('api-keys-form');
        const openAiApiKeyInput = document.getElementById('openai-api-key');
        const anthropicApiKeyInput = document.getElementById('anthropic-api-key');
        const googleApiKeyInput = document.getElementById('google-api-key');

        // AI Provider UI
        const aiProviderSelect = document.getElementById('ai-provider-select');
        const aiModelSelect = document.getElementById('ai-model-select');
        const aiModelSelectionGroup = document.getElementById('ai-model-selection-group');
        const refreshModelsBtn = document.getElementById('refresh-models-btn');
        const ollamaStatus = document.getElementById('ollama-status');
        const providerConfigFieldset = document.querySelector('fieldset');


        // Master AI UI
        const masterPromptTextarea = document.getElementById('master-prompt');
        const numChaptersSelect = document.getElementById('num-chapters');
        const generateCourseBtn = document.getElementById('generate-course-btn');

        let chapterCount = 0;
        const editorInstances = {};

        // --- AI Provider Functions ---

        async function initializeWebLLM() {
            // This function is now only for initializing the engine
            ollamaStatus.textContent = `üîµ Initializing WebLLM...`;
            ollamaStatus.style.color = 'blue';
            try {
                const initProgressCallback = (report) => {
                    ollamaStatus.textContent = `üîµ Initializing WebLLM: ${report.text}`;
                };
                const engine = await webllm.CreateMLCEngine(WEBLLM_MODEL_ID, { initProgressCallback });
                webllmEngine = engine;
                ollamaStatus.textContent = `‚úÖ WebLLM is ready.`;
                ollamaStatus.style.color = 'green';
            } catch (err) {
                ollamaStatus.textContent = `‚ùå Error initializing WebLLM: ${err.message}`;
                ollamaStatus.style.color = 'red';
                console.error("WebLLM Initialization Error:", err);
            }
        }

        async function updateAvailableProviders() {
            ollamaStatus.textContent = 'Detecting available AI providers...';
            aiProviderSelect.innerHTML = '';

            // 1. Check for Cloud Providers
            if (localStorage.getItem(API_KEYS.openai)) {
                aiProviderSelect.add(new Option("OpenAI (Cloud)", "openai"));
            }
            if (localStorage.getItem(API_KEYS.anthropic)) {
                aiProviderSelect.add(new Option("Anthropic (Cloud)", "anthropic"));
            }
            if (localStorage.getItem(API_KEYS.google)) {
                aiProviderSelect.add(new Option("Google Gemini (Cloud)", "google"));
            }

            // 2. Check for Ollama
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                if (response.ok) {
                    const data = await response.json();
                    if (data.models && data.models.length > 0) {
                        aiProviderSelect.add(new Option("Ollama (Local)", "ollama"));
                    }
                }
            } catch (err) {
                // Ollama is not available, do nothing.
            }

            // 3. Add WebLLM as the final fallback
            aiProviderSelect.add(new Option("WebLLM (In-Browser)", "webllm"));

            // Set the best available provider as the default
            aiProviderSelect.selectedIndex = 0;
            handleProviderChange();
        }

        function handleProviderChange() {
            const selectedProvider = aiProviderSelect.value;
            AI_PROVIDER = selectedProvider;

            aiModelSelectionGroup.style.display = 'none';
            refreshModelsBtn.style.display = 'none';
            ollamaStatus.textContent = '';

            if (selectedProvider === 'ollama') {
                aiModelSelectionGroup.style.display = 'flex';
                refreshModelsBtn.style.display = 'block';
                loadOllamaModels();
            } else if (selectedProvider === 'webllm') {
                if (!webllmEngine) {
                    initializeWebLLM();
                } else {
                    ollamaStatus.textContent = `‚úÖ WebLLM is ready.`;
                }
            } else { // Cloud providers
                 ollamaStatus.textContent = `‚úÖ Ready to use ${selectedProvider}.`;
            }
        }

        async function loadOllamaModels() {
            ollamaStatus.textContent = 'Loading Ollama models...';
            aiModelSelect.innerHTML = '';
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                const data = await response.json();
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        aiModelSelect.add(new Option(model.name, model.name));
                    });
                    ollamaStatus.textContent = `‚úÖ Ollama connected. ${data.models.length} model(s) found.`;
                } else {
                     ollamaStatus.textContent = `‚ö†Ô∏è Ollama is running but no models found.`;
                }
            } catch(err) {
                 ollamaStatus.textContent = `‚ùå Could not connect to Ollama.`;
            }
        }

        async function generateAIText(systemPrompt) {
            const provider = aiProviderSelect.value;
            let endpoint = '';
            let headers = { 'Content-Type': 'application/json' };
            let body = {};
            let apiKey = '';

            switch (provider) {
                case 'openai':
                    apiKey = localStorage.getItem(API_KEYS.openai);
                    if (!apiKey) throw new Error("OpenAI API key is missing.");
                    endpoint = 'https://api.openai.com/v1/chat/completions';
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    body = {
                        model: "gpt-4o",
                        messages: [{ role: 'user', content: systemPrompt }],
                        stream: false
                    };
                    break;

                case 'anthropic':
                    apiKey = localStorage.getItem(API_KEYS.anthropic);
                    if (!apiKey) throw new Error("Anthropic API key is missing.");
                    endpoint = 'https://api.anthropic.com/v1/messages';
                    headers['x-api-key'] = apiKey;
                    headers['anthropic-version'] = '2023-06-01';
                    body = {
                        model: "claude-3-haiku-20240307",
                        max_tokens: 4096,
                        messages: [{ role: 'user', content: systemPrompt }]
                    };
                    break;

                case 'google':
                    apiKey = localStorage.getItem(API_KEYS.google);
                    if (!apiKey) throw new Error("Google Gemini API key is missing.");
                    endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                    body = {
                        contents: [{ parts:[{ text: systemPrompt }] }]
                    };
                    // Google uses the key in the URL, so no special auth header is needed.
                    break;

                case 'ollama':
                    const ollamaModel = aiModelSelect.value;
                    if (!ollamaModel) throw new Error("No Ollama model selected.");
                    endpoint = 'http://localhost:11434/api/chat';
                    body = {
                        model: ollamaModel,
                        messages: [{ role: 'user', content: systemPrompt }],
                        stream: false
                    };
                    break;

                case 'webllm':
                    if (!webllmEngine) throw new Error("WebLLM engine is not initialized.");
                    const webllmReply = await webllmEngine.chat.completions.create({
                        messages: [{ role: 'user', content: systemPrompt }],
                        stream: false
                    });
                    return webllmReply.choices[0].message.content;

                default:
                    throw new Error(`Unknown or unsupported AI provider: ${provider}`);
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`${provider} API request failed with status ${response.status}: ${errorBody}`);
            }

            const data = await response.json();

            // Parse response based on provider
            switch (provider) {
                case 'openai':
                    return data.choices[0].message.content;
                case 'anthropic':
                    return data.content[0].text;
                case 'google':
                    return data.candidates[0].content.parts[0].text;
                case 'ollama':
                    return data.message.content;
                default:
                    throw new Error(`Cannot parse response for unknown provider: ${provider}`);
            }
        }


        async function generateCourse() {
            const userPrompt = masterPromptTextarea.value;
            const numChapters = numChaptersSelect.value;

            if (!userPrompt) {
                alert('Please enter a prompt for the course.');
                return;
            }

            aiStatus.style.display = 'block';
            aiStatus.textContent = 'Generating course details...';

            const systemPrompt = `You are an expert course creator. A user wants a course about the following topic: "${userPrompt}".

Your task is to generate a course title and a short, compelling course description.
Do not include any other text, explanations, or markdown formatting.
You MUST format your response as follows:
Title: [The course title]
Description: [The course description]`;

            try {
                const content = await generateAIText(systemPrompt);
                if (!content || content.trim() === '') {
                    throw new Error("The AI model returned an empty response.");
                }
                aiStatus.textContent = "AI generation complete. Parsing response and populating form...";
                parseAndPopulateCourseDetails(content);
            } catch (err) {
                aiStatus.textContent = `Error generating course: ${err.message}`;
                console.error(err);
            }
        }

        function parseAndPopulateCourseDetails(textResponse) {
            try {
                const lines = textResponse.split('\n');
                const titleLine = lines.find(line => line.toLowerCase().startsWith('title:'));
                const descriptionLine = lines.find(line => line.toLowerCase().startsWith('description:'));

                if (!titleLine || !descriptionLine) {
                    throw new Error("AI response did not follow the expected 'Title: ...' and 'Description: ...' format.");
                }

                const courseTitle = titleLine.substring('title:'.length).trim();
                const courseDescription = descriptionLine.substring('description:'.length).trim();

                if (!courseTitle || !courseDescription) {
                     throw new Error("Extracted title or description is empty.");
                }

                courseNameInput.value = courseTitle;
                courseDescTextarea.value = courseDescription;

                // Clear existing chapters before generating new ones
                chaptersContainer.innerHTML = '';
                Object.keys(editorInstances).forEach(key => delete editorInstances[key]);
                chapterCount = 0;

                aiStatus.textContent = "‚úÖ Course details populated. Now generating chapters one by one...";

                // This is where the next step will kick in.
                generateChaptersInLoop();

            } catch (err) {
                aiStatus.textContent = `Error parsing course details from AI. Please try again.\n\nError: ${err.message}`;
                console.error("Invalid JSON response from Ollama for course details:", jsonString);
            }
        }

        async function generateChapter(courseTitle, chapterIndex, totalChapters) {
            const systemPrompt = `You are an expert course creator generating a chapter for a course titled "${courseTitle}".
This is chapter number ${chapterIndex} of ${totalChapters}.

Your task is to generate a title and the full content for this single chapter.
Do not include any other text or explanations.
You MUST format your response as follows, with the content starting on the line immediately after the "Content:" marker:
Title: [The chapter title]
Content:
[The full chapter content in Markdown]`;

            const textResponse = await generateAIText(systemPrompt);
            if (!textResponse) {
                throw new Error(`AI returned an empty response for chapter ${chapterIndex}.`);
            }

            const lines = textResponse.split('\n');
            const titleLine = lines.find(line => line.toLowerCase().startsWith('title:'));
            const contentStartIndex = lines.findIndex(line => line.toLowerCase().startsWith('content:'));

            if (!titleLine || contentStartIndex === -1) {
                throw new Error(`AI response for chapter ${chapterIndex} did not follow the expected format.`);
            }

            const title = titleLine.substring('title:'.length).trim();
            // The content is everything after the "Content:" marker line
            const content = lines.slice(contentStartIndex + 1).join('\n').trim();

            if (!title || !content) {
                throw new Error(`Extracted title or content for chapter ${chapterIndex} is empty.`);
            }

            return { title, content };
        }

        async function generateChaptersInLoop() {
            const numChapters = parseInt(numChaptersSelect.value, 10);
            const courseTitle = courseNameInput.value;

            for (let i = 1; i <= numChapters; i++) {
                try {
                    aiStatus.textContent = `Generating chapter ${i} of ${numChapters}...`;
                    addChapter(); // Add a new chapter section to the UI

                    const chapterData = await generateChapter(courseTitle, i, numChapters);

                    if (!chapterData.title || !chapterData.content) {
                         throw new Error("The AI response for the chapter is missing 'title' or 'content'.");
                    }

                    const newChapterId = chapterCount;
                    const titleInput = document.getElementById(`chapter-title-${newChapterId}`);
                    const editor = editorInstances[newChapterId];

                    if (titleInput) titleInput.value = chapterData.title;
                    if (editor) editor.setMarkdown(chapterData.content);

                } catch (err) {
                    aiStatus.textContent = `Error generating chapter ${i}. Please try again.\n\nError: ${err.message}`;
                    // Stop the loop if a chapter fails
                    return;
                }
            }
             aiStatus.textContent = "‚úÖ All chapters have been successfully generated!";
             saveState(); // Save the final generated state
             setTimeout(() => { aiStatus.style.display = 'none'; }, 5000);
        }


        // --- State Management ---
        const LOCAL_STORAGE_KEY = "courseCreatorState";

        function saveState() {
            const chapters = [];
            document.querySelectorAll('.chapter').forEach(chapterDiv => {
                const chapterId = chapterDiv.id.split('-')[1];
                const title = document.getElementById(`chapter-title-${chapterId}`).value;
                const editor = editorInstances[chapterId];
                const content = editor ? editor.getMarkdown() : '';
                chapters.push({ title, content });
            });

            const state = {
                courseName: courseNameInput.value,
                courseDesc: courseDescTextarea.value,
                chapters: chapters,
                ollamaModel: ollamaModelSelect.value,
                masterPrompt: masterPromptTextarea.value,
                numChapters: numChaptersSelect.value
            };

            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
            console.log("State saved.");
        }

        function loadState() {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!savedState) return;

            console.log("Found saved state, loading...");
            const state = JSON.parse(savedState);

            courseNameInput.value = state.courseName || '';
            courseDescTextarea.value = state.courseDesc || '';
            ollamaModelSelect.value = state.ollamaModel || 'llama3';
            masterPromptTextarea.value = state.masterPrompt || '';
            numChaptersSelect.value = state.numChapters || '5';

            chaptersContainer.innerHTML = '';
            Object.keys(editorInstances).forEach(key => delete editorInstances[key]);
            chapterCount = 0;

            if (state.chapters && state.chapters.length > 0) {
                state.chapters.forEach(chapterData => {
                    addChapter();
                    const newChapterId = chapterCount;
                    const titleInput = document.getElementById(`chapter-title-${newChapterId}`);
                    const editor = editorInstances[newChapterId];
                    if (titleInput) titleInput.value = chapterData.title;
                    if (editor) editor.setMarkdown(chapterData.content);
                });
            } else {
                // If there are no chapters in state, add one empty one
                addChapter();
            }
        }

        function clearState() {
            if (confirm("Are you sure you want to clear the form and start a new course? All current content will be lost.")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                location.reload();
            }
        }

        // --- Event Listeners ---
        refreshModelsBtn.addEventListener('click', loadOllamaModels);
        generateCourseBtn.addEventListener('click', generateCourse);
        // --- Settings Modal Logic & Key Storage ---
        const API_KEYS = {
            openai: "openai_api_key",
            anthropic: "anthropic_api_key",
            google: "google_api_key"
        };

        function saveApiKeys(e) {
            e.preventDefault();
            localStorage.setItem(API_KEYS.openai, openAiApiKeyInput.value);
            localStorage.setItem(API_KEYS.anthropic, anthropicApiKeyInput.value);
            localStorage.setItem(API_KEYS.google, googleApiKeyInput.value);
            hideSettingsModal();
            updateAvailableProviders();
            alert("API Keys saved!");
        }

        function loadApiKeys() {
            openAiApiKeyInput.value = localStorage.getItem(API_KEYS.openai) || '';
            anthropicApiKeyInput.value = localStorage.getItem(API_KEYS.anthropic) || '';
            googleApiKeyInput.value = localStorage.getItem(API_KEYS.google) || '';
        }

        function showSettingsModal() {
            settingsModal.classList.add('visible');
        }
        function hideSettingsModal() {
            settingsModal.classList.remove('visible');
        }

        settingsBtn.addEventListener('click', showSettingsModal);
        closeSettingsBtn.addEventListener('click', hideSettingsModal);
        apiKeysForm.addEventListener('submit', saveApiKeys);
        settingsModal.addEventListener('click', (e) => {
            // Close if clicking on the overlay but not the content
            if (e.target === settingsModal) {
                hideSettingsModal();
            }
        });


        aiProviderSelect.addEventListener('change', handleProviderChange);


        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();
            updateAvailableProviders();
            loadState();
        });
        document.getElementById('clear-form-btn').addEventListener('click', clearState);

        // Auto-save on manual edits
        courseNameInput.addEventListener('input', saveState);
        courseDescTextarea.addEventListener('input', saveState);
        masterPromptTextarea.addEventListener('input', saveState);
        ollamaModelSelect.addEventListener('change', saveState);
        numChaptersSelect.addEventListener('change', saveState);
        chaptersContainer.addEventListener('input', (e) => {
            if (e.target && e.target.classList.contains('chapter-title')) {
                saveState();
            }
        });


        // --- Existing Functions (to be refactored) ---

        const slugify = (text) => {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        };

        const addChapter = () => {
            chapterCount++;
            const chapterId = chapterCount;
            const chapterDiv = document.createElement('div');
            chapterDiv.className = 'chapter';
            chapterDiv.id = `chapter-${chapterId}`;
            chapterDiv.innerHTML = `
                <div class="chapter-header">
                    <h3>Chapter ${chapterId}</h3>
                    <button type="button" class="btn btn-danger remove-chapter-btn" data-chapter-id="${chapterId}">Remove</button>
                </div>
                <label for="chapter-title-${chapterId}">Chapter Title</label>
                <input type="text" id="chapter-title-${chapterId}" class="chapter-title" placeholder="e.g., Getting Started" required>
                <label for="editor-${chapterId}">Chapter Content</label>
                <div id="editor-${chapterId}" class="chapter-editor"></div>
            `;
            chaptersContainer.appendChild(chapterDiv);

            const editor = new toastui.Editor({
                el: document.querySelector(`#editor-${chapterId}`),
                height: '250px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                toolbarItems: [
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task', 'indent', 'outdent'],
                    ['table', 'image', 'link'],
                    ['code', 'codeblock'],
                    ['scrollSync'],
                ],
                events: {
                    change: () => saveState()
                }
            });
            editorInstances[chapterId] = editor;

            chapterDiv.querySelector('.remove-chapter-btn').addEventListener('click', () => {
                const id = chapterDiv.querySelector('.remove-chapter-btn').dataset.chapterId;
                delete editorInstances[id];
                document.getElementById(`chapter-${id}`).remove();
            });
        };

        addChapterBtn.addEventListener('click', addChapter);

        // Add one chapter by default so the page isn't empty
        addChapter();

        async function translate(textToTranslate, targetLangName) {
            const prompt = `Translate the following text to ${targetLangName}. Only provide the raw, translated text. Do not include any explanations, introductory phrases, or quotation marks. The text to translate is:\n\n"${textToTranslate}"`;

            try {
                const translatedText = await generateAIText(prompt);
                return translatedText.trim() || textToTranslate;
            } catch (err) {
                console.error(`Translation to ${targetLangName} failed:`, err);
                // Fallback to original text if translation fails
                return textToTranslate;
            }
        }

        courseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = courseForm.querySelector('button[type="submit"]');

            try {
                submitBtn.disabled = true;
                aiStatus.style.display = 'block';
                aiStatus.textContent = 'Gathering course content...';

                const courseName = courseNameInput.value;
                const courseDesc = courseDescTextarea.value;
                const selectedLangs = Array.from(document.querySelectorAll('.lang-grid input[type="checkbox"]:checked')).map(cb => cb.value);

                if (selectedLangs.length === 0) {
                    alert('Please select at least one language.');
                    return;
                }
                const courseSlug = slugify(courseName);
                if (!courseSlug) {
                    alert('Please enter a valid course name.');
                    return;
                }

                const chapters = [];
                document.querySelectorAll('.chapter').forEach((chapterDiv) => {
                    const chapterId = chapterDiv.id.split('-')[1];
                    const title = document.getElementById(`chapter-title-${chapterId}`).value;
                    const editor = editorInstances[chapterId];
                    const content = editor ? editor.getMarkdown() : '';
                    const chapterSlug = slugify(title);
                    const chapterNumber = String(chapters.length + 1).padStart(2, '0');
                    chapters.push({ title, content, slug: chapterSlug, number: chapterNumber });
                });

                if (chapters.length === 0) {
                    alert('Please add at least one chapter.');
                    return;
                }

                const zip = new JSZip();
                const courseFolder = zip.folder(courseSlug);
                courseFolder.folder('assets');

                const langCheckboxes = Object.fromEntries(
                    Array.from(document.querySelectorAll('.lang-item input[type="checkbox"]'))
                    .map(cb => [cb.value, cb])
                );

                const nonEnglishLangs = selectedLangs.filter(l => l !== 'en');
                const progress = {
                    completed: 0,
                    total: nonEnglishLangs.length * (1 + 1 + chapters.length * 2)
                };

                if (progress.total > 0) {
                    aiStatus.textContent = `Starting translation of ${progress.total} items across ${nonEnglishLangs.length} language(s)...`;
                }

                const processingPromises = selectedLangs.map(async (lang) => {
                    const langName = langCheckboxes[lang]?.dataset.name;
                    if (!langName) return;

                    let translatedCourseName = courseName;
                    let translatedCourseDesc = courseDesc;
                    let translatedChapters = chapters;
                    const isPrimaryLang = lang === 'en';

                    if (!isPrimaryLang) {
                        const updateProgress = () => {
                            progress.completed++;
                            aiStatus.textContent = `Translating... ${progress.completed} of ${progress.total} items completed.`;
                        };

                        translatedCourseName = await translate(courseName, langName);
                        updateProgress();
                        translatedCourseDesc = await translate(courseDesc, langName);
                        updateProgress();

                        const newChapters = [];
                        for (const chapter of chapters) {
                            const translatedTitle = await translate(chapter.title, langName);
                            updateProgress();
                            const translatedContent = await translate(chapter.content, langName);
                            updateProgress();
                            newChapters.push({ ...chapter, title: translatedTitle, content: translatedContent });
                        }
                        translatedChapters = newChapters;
                    }

                    const indexContent = `---\ndescription: ${translatedCourseDesc}\n---\n\n# ${translatedCourseName}`;
                    courseFolder.file(`index.${lang}.md`, indexContent);

                    for (const chapter of translatedChapters) {
                        const chapterFilename = `${chapter.number}-${chapter.slug}.${lang}.md`;
                        const chapterContent = `# ${chapter.title}\n\n${chapter.content}`;
                        courseFolder.file(chapterFilename, chapterContent);
                    }
                });

                await Promise.all(processingPromises);

                aiStatus.textContent = 'All translations complete. Now packaging your course files into a .zip file...';
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                downloadZipLink.href = URL.createObjectURL(zipBlob);
                downloadZipLink.download = `${courseSlug}.zip`;
                downloadSection.style.display = 'block';
                aiStatus.textContent = '‚úÖ Success! Your course files have been packaged. Click the download link that has appeared.';

            } finally {
                submitBtn.disabled = false;
            }
        });

    </script>

</body>
</html>
