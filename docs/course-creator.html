<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Course Creator</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f9f9f9; }
        h1, h2, h3 { color: #2c3e50; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; }
        .instructions { background-color: #eaf5ff; border-left: 4px solid #3498db; padding: 1rem; margin-bottom: 2rem; border-radius: 4px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        #settings-btn { position: absolute; top: 1rem; right: 1rem; cursor: pointer; width: 24px; height: 24px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 1rem; }
        textarea { min-height: 100px; resize: vertical; }
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        legend { font-weight: bold; padding: 0 0.5rem; }
        .lang-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .lang-item { display: flex; align-items: center; }
        input[type="checkbox"] { margin-right: 0.5rem; }
        .chapter { border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; background-color: #fafafa; }
        .chapter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 1rem; }
        .btn-primary { background-color: #3498db; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #2ecc71; }
        .btn-secondary:hover { background-color: #27ae60; }
        .btn-danger { background-color: #e74c3c; padding: 0.25rem 0.75rem; }
        .btn-danger:hover { background-color: #c0392b; }
        #download-section { margin-top: 2rem; padding: 1rem; background-color: #f0fff4; border: 1px solid #2ecc71; border-radius: 4px; display: none; }
        .input-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .input-group input, .input-group textarea { flex-grow: 1; margin-bottom: 0 !important; }
        .btn-ai { padding: 0.5rem 1rem; }
        .ai-assistant { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin-top: 1rem; }
        .ai-assistant h4 { margin-top: 0; }
        #ai-status { margin: 1rem 0; padding: 1rem; background-color: #fefae0; border: 1px solid #f0ad4e; border-radius: 4px; white-space: pre-wrap; display: none; }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Settings</h2>
            <label for="ollama-url">Ollama URL</label>
            <input type="text" id="ollama-url" placeholder="http://localhost:11434">
            <button id="save-settings-btn" class="btn btn-primary">Save</button>
        </div>
    </div>

    <div class="container">
        <div id="settings-btn">
            <svg width="24px" height="24px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <defs>
                    <path id="gear-a" d="M5.46149909,9.95180254 C5.63620018,9.98346549 5.81616917,10 6,10 C7.65685425,10 9,8.65685425 9,7 C9,5.53349268 7.94774015,4.31275382 6.55705846,4.05162142 C7.45122895,1.18485705 9.22761962,0.0496486084 11.8862305,0.645996094 L13.2197266,1.76025391 L15.105957,1.76025391 L16.1420898,4.23486328 L14.359375,5.56933594 L14.359375,7.92236328 L16.1420898,10.2104492 L15.105957,11.8408203 L13.2197266,11.8408203 L11.2119141,12.9389648 L11.2119141,15.7773438 L8.80029297,17.2216797 L6.25390625,15.0439453 L4.68408203,15.0439453 L2.80810547,17.2216797 L0.621582031,15.7773437 L0.621582031,12.9389648 C3.01108587,13.7471942 4.62439155,12.7514734 5.46149909,9.95180254 Z M6,8 C5.44771525,8 5,7.55228475 5,7 C5,6.44771525 5.44771525,6 6,6 C6.55228475,6 7,6.44771525 7,7 C7,7.55228475 6.55228475,8 6,8 Z"/>
                    <path id="gear-c" d="M2,7.86677785 C3.10540596,8.47421806 3.8545971,9.64961755 3.8545971,11 C3.8545971,12.3503825 3.10540596,13.5257819 2,14.1332221 C2.12113545,14.481215 2.26188408,14.8200223 2.42092213,15.1483205 C3.63198544,14.7963908 4.9926792,15.0978049 5.94743715,16.0525628 C6.9021951,17.0073208 7.20360923,18.3680146 6.85167954,19.5790779 C7.17997769,19.7381159 7.51878505,19.8788646 7.86677785,20 C8.47421806,18.894594 9.64961755,18.1454029 11,18.1454029 C12.3503825,18.1454029 13.5257819,18.894594 14.1332221,20 C14.481215,19.8788646 14.8200223,19.7381159 15.1483205,19.5790779 C14.7963908,18.3680146 15.0978049,17.0073208 16.0525628,16.0525628 C17.0073208,15.0978049 18.3680146,14.7963908 19.5790779,15.1483205 C19.7381159,14.8200223 19.8788646,14.481215 20,14.1332221 C18.894594,13.5257819 18.1454029,12.3503825 18.1454029,11 C18.1454029,9.64961755 18.894594,8.47421806 20,7.86677785 C19.8788646,7.51878505 19.7381159,7.17997769 19.5790779,6.85167954 C18.3680146,7.20360923 17.0073208,6.9021951 16.0525628,5.94743715 C15.0978049,4.9926792 14.7963908,3.63198544 15.1483205,2.42092213 C14.8200223,2.26188408 14.481215,2.12113545 14.1332221,2 C13.5257819,3.10540596 12.3503825,3.8545971 11,3.8545971 C9.64961755,3.8545971 8.47421806,3.10540596 7.86677785,2 C7.51878505,2.12113545 7.17997769,2.26188408 6.85167954,2.42092213 C7.20360923,3.63198544 6.9021951,4.9926792 5.94743715,5.94743715 C4.9926792,6.9021951 3.63198544,7.20360923 2.42092213,6.85167954 C2.26188408,7.17997769 2.12113545,7.51878505 2,7.86677785 Z M0.111165567,7.20927919 C0.257299843,6.78947081 0.427580293,6.3790103 0.620999583,5.97973986 C1.04619617,5.10201754 2.04247952,4.65897122 2.97902612,4.93112756 C3.52821874,5.09072053 4.12227919,4.94416799 4.53322359,4.53322359 C4.94416799,4.12227919 5.09072053,3.52821874 4.93112756,2.97902612 C4.65897122,2.04247952 5.10201754,1.04619617 5.97973986,0.620999583 C6.3790103,0.427580293 6.78947081,0.257299843 7.20927919,0.111165567 C8.13094072,-0.209662562 9.14957623,0.181533892 9.61956648,1.03681152 C9.89502663,1.53808769 10.4187709,1.8545971 11,1.8545971 C11.5812291,1.8545971 12.1049734,1.53808769 12.3804335,1.03681152 C12.8504238,0.181533892 13.8690593,-0.209662562 14.7907208,0.111165567 C15.2105292,0.257299843 15.6209897,0.427580293 16.0202601,0.620999583 C16.8979825,1.04619617 17.3410288,2.04247952 17.0688724,2.97902612 C16.9092795,3.52821874 17.055832,4.12227919 17.4667764,4.53322359 C17.8777208,4.94416799 18.4717813,5.09072053 19.0209739,4.93112756 C19.9575205,4.65897122 20.9538038,5.10201754 21.3790004,5.97973986 C21.5724197,6.3790103 21.7427002,6.78947081 21.8888344,7.20927919 C22.2096626,8.13094072 21.8184661,9.14957623 20.9631885,9.61956648 C20.4619123,9.89502663 20.1454029,10.4187709 20.1454029,11 C20.1454029,11.5812291 20.4619123,12.1049734 20.9631885,12.3804335 C21.8184661,12.8504238 22.2096626,13.8690593 21.8888344,14.7907208 C21.7427002,15.2105292 21.5724197,15.6209897 21.3790004,16.0202601 C20.9538038,16.8979825 19.9575205,17.3410288 19.0209739,17.0688724 C18.4717813,16.9092795 17.8777208,17.055832 17.4667764,17.4667764 C17.055832,17.8777208 16.9092795,18.4717813 17.0688724,19.0209739 C17.3410288,19.9575205 16.8979825,20.9538038 16.0202601,21.3790004 C15.6209897,21.5724197 15.2105292,21.7427002 14.7907208,21.8888344 C13.8690593,22.2096626 12.8504238,21.8184661 12.3804335,20.9631885 C12.1049734,20.4619123 11.5812291,20.1454029 11,20.1454029 C10.4187709,20.1454029 9.89502663,20.4619123 9.61956648,20.9631885 C9.14957623,21.8184661 8.13094072,22.2096626 7.20927919,21.8888344 C6.78947081,21.7427002 6.3790103,21.5724197 5.97973986,21.3790004 C5.10201754,20.9538038 4.65897122,19.9575205 4.93112756,19.0209739 C5.09072053,18.4717813 4.94416799,17.8777208 4.53322359,17.4667764 C4.12227919,17.055832 3.52821874,16.9092795 2.97902612,17.0688724 C2.04247952,17.3410288 1.04619617,16.8979825 0.620999583,16.0202601 C0.427580293,15.6209897 0.257299843,15.2105292 0.111165567,14.7907208 C-0.209662562,13.8690593 0.181533892,12.8504238 1.03681152,12.3804335 C1.53808769,12.1049734 1.8545971,11.5812291 1.8545971,11 C1.8545971,10.4187709 1.53808769,9.89502663 1.03681152,9.61956648 C0.181533892,9.14957623 -0.209662562,8.13094072 0.111165567,7.20927919 Z M11,15 C13.209139,15 15,13.209139 15,11 C15,8.790861,13.209139,7 11,7 C8.790861,7 7,8.790861 7,11 C7,13.209139 8.790861,15 11,15 Z M11,13 C9.8954305,13 9,12.1045695 9,11 C9,9.8954305 9.8954305,9 11,9 C12.1045695,9 13,9.8954305 13,11 C13,12.1045695 12.1045695,13 11,13 Z"/>
                </defs>
                <g fill="none" fill-rule="evenodd" transform="translate(1 1)">
                    <g transform="translate(5 4)">
                        <mask id="gear-b" fill="#ffffff">
                            <use xlink:href="#gear-a"/>
                        </mask>
                        <use fill="#D8D8D8" xlink:href="#gear-a"/>
                        <g fill="#FFA0A0" mask="url(#gear-b)">
                            <rect width="24" height="24" transform="translate(-6 -5)"/>
                        </g>
                    </g>
                    <mask id="gear-d" fill="#ffffff">
                        <use xlink:href="#gear-c"/>
                    </mask>
                    <use fill="#000000" fill-rule="nonzero" xlink:href="#gear-c"/>
                    <g fill="#7600FF" mask="url(#gear-d)">
                        <rect width="24" height="24" transform="translate(-1 -1)"/>
                    </g>
                </g>
            </svg>
        </div>
        <h1>Universal Course Creator</h1>
        <div id="ai-status" style="white-space: pre-wrap; display: none;"></div>

        <div class="instructions">
            <h3>How to Use This Tool</h3>
            <ol>
                <li>The tool will first check for a local Ollama server. If found, you can select any of your downloaded models.</li>
                <li>If a local Ollama server is not found, the tool will automatically fall back to using an in-browser AI model (Phi-3-mini). Please be patient as the model may take some time to load.</li>
                <li>Once the AI Engine is ready, enter a topic for your course and select the number of chapters.</li>
                <li>Click "Generate Course". The AI will populate the course details and chapters for you.</li>
                <li>Review and edit the generated content as needed.</li>
                <li>Select the languages you want to translate the course into.</li>
                <li>Click "Generate Course Files". This will create a .zip file with all the markdown files.</li>
            </ol>
        </div>

        <fieldset>
            <legend>AI Engine Configuration</legend>
            <div id="ai-config-container">
                <!-- This will be populated by JavaScript -->
            </div>
            <div id="ai-engine-status" style="margin-top: 0.5rem; font-weight: bold;">Checking for local Ollama server...</div>
        </fieldset>

        <fieldset>
            <legend>Master AI Assistant</legend>
            <label for="master-prompt">Course Prompt</label>
            <textarea id="master-prompt" placeholder="e.g., 'Create a comprehensive course about the history of ancient Rome, from its founding to the fall of the Western Empire.'"></textarea>
            <div class="input-group">
                <label for="num-chapters" style="flex-shrink: 0; margin-bottom: 0;">Number of Chapters:</label>
                <select id="num-chapters" style="margin-bottom: 0;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <button type="button" id="generate-course-btn" class="btn btn-secondary" style="margin-left: 1rem;">Generate Entire Course</button>
            </div>
        </fieldset>

        <hr style="margin: 2rem 0;">

        <form id="course-form">
            <h2>Course Details</h2>
            <label for="course-name">Course Name</label>
            <input type="text" id="course-name" placeholder="Generated by AI" required>

            <label for="course-desc">Course Description (for main landing page)</label>
            <textarea id="course-desc" placeholder="Generated by AI" required></textarea>

            <h2>Chapters</h2>
            <div id="chapters-container">
                <!-- Chapters will be dynamically added here by the master AI or manually -->
            </div>
            <div class="input-group">
                <button type="button" id="add-chapter" class="btn btn-secondary">Add Chapter Manually</button>
                <button type="button" id="clear-form-btn" class="btn btn-danger" style="margin-left: auto;">Clear Form & Start New</button>
            </div>

            <fieldset style="margin-top: 2rem;">
                <legend>Course Languages</legend>
                <div class="lang-grid">
                    <div class="lang-item" title="English">
                        <input type="checkbox" id="lang-en" value="en" data-name="English" checked>
                        <img src="https://flagcdn.com/us.svg" alt="USA Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-en" style="flex-grow: 1;">⭐ English</label>
                    </div>
                    <div class="lang-item" title="German">
                        <input type="checkbox" id="lang-de" value="de" data-name="German">
                        <img src="https://flagcdn.com/de.svg" alt="German Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-de" style="flex-grow: 1;">German</label>
                    </div>
                    <div class="lang-item" title="Mandarin Chinese">
                        <input type="checkbox" id="lang-zh" value="zh" data-name="Mandarin Chinese">
                        <img src="https://flagcdn.com/cn.svg" alt="Chinese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-zh" style="flex-grow: 1;">Mandarin Chinese</label>
                    </div>
                    <div class="lang-item" title="Spanish">
                        <input type="checkbox" id="lang-es" value="es" data-name="Spanish">
                        <img src="https://flagcdn.com/es.svg" alt="Spanish Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-es" style="flex-grow: 1;">Spanish</label>
                    </div>
                    <div class="lang-item" title="Hindi">
                        <input type="checkbox" id="lang-hi" value="hi" data-name="Hindi">
                        <img src="https://flagcdn.com/in.svg" alt="Indian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-hi" style="flex-grow: 1;">Hindi</label>
                    </div>
                    <div class="lang-item" title="Portuguese">
                        <input type="checkbox" id="lang-pt" value="pt" data-name="Portuguese">
                        <img src="https://flagcdn.com/pt.svg" alt="Portuguese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-pt" style="flex-grow: 1;">Portuguese</label>
                    </div>
                    <div class="lang-item" title="Russian">
                        <input type="checkbox" id="lang-ru" value="ru" data-name="Russian">
                        <img src="https://flagcdn.com/ru.svg" alt="Russian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ru" style="flex-grow: 1;">Russian</label>
                    </div>
                    <div class="lang-item" title="Japanese">
                        <input type="checkbox" id="lang-ja" value="ja" data-name="Japanese">
                        <img src="https://flagcdn.com/jp.svg" alt="Japanese Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ja" style="flex-grow: 1;">Japanese</label>
                    </div>
                    <div class="lang-item" title="French">
                        <input type="checkbox" id="lang-fr" value="fr" data-name="French">
                        <img src="https://flagcdn.com/fr.svg" alt="French Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-fr" style="flex-grow: 1;">French</label>
                    </div>
                    <div class="lang-item" title="Italian">
                        <input type="checkbox" id="lang-it" value="it" data-name="Italian">
                        <img src="https://flagcdn.com/it.svg" alt="Italian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-it" style="flex-grow: 1;">Italian</label>
                    </div>
                    <div class="lang-item" title="Romanian">
                        <input type="checkbox" id="lang-ro" value="ro" data-name="Romanian">
                        <img src="https://flagcdn.com/ro.svg" alt="Romanian Flag" style="width: 24px; margin-right: 0.5rem;">
                        <label for="lang-ro" style="flex-grow: 1;">Romanian</label>
                    </div>
                </div>
            </fieldset>

            <hr style="margin: 2rem 0;">

            <button type="submit" class="btn btn-primary">Generate Course Files</button>
        </form>

        <div id="download-section">
            <h3>Downloads</h3>
            <p>Your files have been generated. Download them below.</p>
            <a id="download-zip" class="btn btn-primary">Download Course Files (.zip)</a>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Main Application Logic -->
    <script type="module">
        import { CreateWebWorkerEngine } from '../libs/webllm.js';

        const WEBLLM_MODEL_ID = "Phi-3-mini-4k-instruct";

        // DOM Elements
        const courseForm = document.getElementById('course-form');
        const chaptersContainer = document.getElementById('chapters-container');
        const addChapterBtn = document.getElementById('add-chapter');
        const downloadSection = document.getElementById('download-section');
        const downloadZipLink = document.getElementById('download-zip');
        const aiStatus = document.getElementById('ai-status');
        const courseNameInput = document.getElementById('course-name');
        const courseDescTextarea = document.getElementById('course-desc');
        const aiEngineStatus = document.getElementById('ai-engine-status');
        const aiConfigContainer = document.getElementById('ai-config-container');
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeBtn = document.querySelector('.close-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const ollamaUrlInput = document.getElementById('ollama-url');

        // Master AI UI
        const masterPromptTextarea = document.getElementById('master-prompt');
        const numChaptersSelect = document.getElementById('num-chapters');
        const generateCourseBtn = document.getElementById('generate-course-btn');
        generateCourseBtn.disabled = true; // Disable until an engine is ready

        let chapterCount = 0;
        const editorInstances = {};

        // AI State
        let activeAIEngine = null; // 'ollama' or 'webllm'
        let webLlmEngine = null;

        // --- AI Engine Initialization ---
        async function initializeAI() {
            console.log("Initializing AI...");
            try {
                // Try Ollama first
                console.log("Trying to get Ollama models...");
                const ollamaModels = await getOllamaModels();
                console.log("Successfully got Ollama models:", ollamaModels);
                setupOllamaUI(ollamaModels);
                activeAIEngine = 'ollama';
                const initialModel = document.getElementById('ollama-model').value;
                aiEngineStatus.textContent = `✅ Connected to Ollama. Using model: ${initialModel}`;
                aiEngineStatus.style.color = 'green';
                generateCourseBtn.disabled = false;
            } catch (err) {
                // Fallback to WebLLM
                aiEngineStatus.textContent = 'Local Ollama server not found. Loading in-browser model...';
                aiEngineStatus.style.color = '#e67e22'; // A warning-like color
                console.error("Ollama connection failed, falling back to WebLLM.", err);
                activeAIEngine = 'webllm';
                console.log("Setting up WebLLM UI...");
                setupWebLLMUI();
                console.log("Initializing WebLLM...");
                await initWebLLM();
                console.log("WebLLM initialization finished.");
            }
        }

        // --- Settings Modal ---
        if (settingsBtn) {
            settingsBtn.onclick = () => {
                ollamaUrlInput.value = localStorage.getItem('ollamaUrl') || 'http://localhost:11434';
                settingsModal.style.display = 'block';
            };
        }
        if (closeBtn) {
            closeBtn.onclick = () => { settingsModal.style.display = 'none'; };
        }
        window.onclick = (event) => {
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
        };
        if (saveSettingsBtn) {
            saveSettingsBtn.onclick = () => {
                localStorage.setItem('ollamaUrl', ollamaUrlInput.value);
                settingsModal.style.display = 'none';
                // Re-initialize AI to apply the new settings
                initializeAI();
            };
        }


        // --- Ollama Functions ---
        async function getOllamaModels() {
            const ollamaUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434';
            console.log("Inside getOllamaModels");
            // Give the local server a short timeout to respond
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.log("Ollama fetch timeout triggered.");
                controller.abort();
            }, 2000);

            try {
                console.log("Fetching Ollama tags from:", ollamaUrl);
                const response = await fetch(`${ollamaUrl}/api/tags`, { signal: controller.signal });
                console.log("Ollama fetch response received:", response);
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`Ollama server responded with status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Ollama data received:", data);
                if (!data.models || data.models.length === 0) {
                    throw new Error('No Ollama models found.');
                }
                return data.models;
            } catch (error) {
                console.error("Error in getOllamaModels:", error);
                clearTimeout(timeoutId);
                throw error;
            }
        }

        function setupOllamaUI(models) {
            aiConfigContainer.innerHTML = `
                <div class="input-group">
                    <label for="ollama-model" style="flex-shrink: 0; margin-bottom: 0;">Ollama Model:</label>
                    <select id="ollama-model" style="margin-bottom: 0;"></select>
                </div>
            `;
            const ollamaModelSelect = document.getElementById('ollama-model');
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.name;
                ollamaModelSelect.appendChild(option);
            });
            ollamaModelSelect.addEventListener('change', () => {
                aiEngineStatus.textContent = `✅ Connected to Ollama. Using model: ${ollamaModelSelect.value}`;
                saveState(); // Save state when model changes
            });
        }

        // --- WebLLM Functions ---
        function setupWebLLMUI() {
            aiConfigContainer.innerHTML = ''; // No config needed for WebLLM
        }

        async function initWebLLM() {
            aiEngineStatus.textContent = 'Loading in-browser AI model (Phi-3-mini)...';
            const progressCallback = (progress) => {
                aiEngineStatus.textContent = `Loading: ${progress.text}`;
            };
            try {
                webLlmEngine = await CreateWebWorkerEngine(WEBLLM_MODEL_ID, { init: progressCallback });
                aiEngineStatus.textContent = "✅ In-browser AI Ready";
                aiEngineStatus.style.color = 'green';
                generateCourseBtn.disabled = false;
            } catch (err) {
                aiEngineStatus.textContent = `❌ Engine initialization failed. ${err.message}`;
                aiEngineStatus.style.color = 'red';
                console.error("WebLLM Init Error:", err);
            }
        }

        // --- Unified AI Prompt Function ---
        async function runAIPrompt(prompt) {
            if (activeAIEngine === 'ollama') {
                const ollamaUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434';
                const model = document.getElementById('ollama-model').value;
                const response = await fetch(`${ollamaUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        stream: false
                    }),
                });
                if (!response.ok) throw new Error(`Ollama API request failed with status ${response.status}`);
                const data = await response.json();
                return data.message.content;
            } else if (activeAIEngine === 'webllm') {
                if (!webLlmEngine) throw new Error("WebLLM engine is not initialized.");
                const messages = [{ role: "user", content: prompt }];
                const reply = await webLlmEngine.chat.completions.create({ messages, stream: false });
                return reply.choices[0].message.content;
            } else {
                throw new Error("No AI engine is active.");
            }
        }

        async function generateCourse() {
            const userPrompt = masterPromptTextarea.value;
            if (!userPrompt) {
                alert('Please enter a prompt for the course.');
                return;
            }
            aiStatus.style.display = 'block';
            aiStatus.textContent = 'Generating course details...';
            const systemPrompt = `You are an expert course creator. A user wants a course about the following topic: "${userPrompt}".

Your task is to generate a course title and a short, compelling course description.
Do not include any other text, explanations, or markdown formatting.
You MUST format your response as follows:
Title: [The course title]
Description: [The course description]`;
            try {
                const content = await runAIPrompt(systemPrompt);
                if (!content || content.trim() === '') {
                    aiStatus.textContent += `\n\nError: The AI model returned an empty response.`;
                    return;
                }
                aiStatus.textContent += "\n\nAI generation complete. Parsing response and populating form...";
                parseAndPopulateCourseDetails(content);
            } catch (err) {
                aiStatus.textContent = `Error generating course: ${err.message}`;
                console.error(err);
            }
        }

        function parseAndPopulateCourseDetails(textResponse) {
            try {
                const lines = textResponse.split('\n');
                const titleLine = lines.find(line => line.toLowerCase().startsWith('title:'));
                const descriptionLine = lines.find(line => line.toLowerCase().startsWith('description:'));
                if (!titleLine || !descriptionLine) {
                    throw new Error("AI response did not follow the expected 'Title: ...' and 'Description: ...' format.");
                }
                const courseTitle = titleLine.substring('title:'.length).trim();
                const courseDescription = descriptionLine.substring('description:'.length).trim();
                if (!courseTitle || !courseDescription) {
                     throw new Error("Extracted title or description is empty.");
                }
                courseNameInput.value = courseTitle;
                courseDescTextarea.value = courseDescription;
                chaptersContainer.innerHTML = '';
                Object.keys(editorInstances).forEach(key => delete editorInstances[key]);
                chapterCount = 0;
                aiStatus.textContent = "✅ Course details populated. Now generating chapters one by one...";
                generateChaptersInLoop();
            } catch (err) {
                aiStatus.textContent = `Error parsing course details from AI. Please try again.\n\nError: ${err.message}`;
                console.error("Error parsing AI response:", textResponse);
            }
        }

        async function generateChapter(courseTitle, chapterIndex, totalChapters) {
            const systemPrompt = `You are an expert course creator generating a chapter for a course titled "${courseTitle}".
This is chapter number ${chapterIndex} of ${totalChapters}.

Your task is to generate a title and the full content for this single chapter.
Do not include any other text or explanations.
You MUST format your response as follows, with the content starting on the line immediately after the "Content:" marker:
Title: [The chapter title]
Content:
[The full chapter content in Markdown]`;
            const textResponse = await runAIPrompt(systemPrompt);
            if (!textResponse) {
                throw new Error(`AI returned an empty response for chapter ${chapterIndex}.`);
            }
            const lines = textResponse.split('\n');
            const titleLine = lines.find(line => line.toLowerCase().startsWith('title:'));
            const contentStartIndex = lines.findIndex(line => line.toLowerCase().startsWith('content:'));
            if (!titleLine || contentStartIndex === -1) {
                throw new Error(`AI response for chapter ${chapterIndex} did not follow the expected format.`);
            }
            const title = titleLine.substring('title:'.length).trim();
            const content = lines.slice(contentStartIndex + 1).join('\n').trim();
            if (!title || !content) {
                throw new Error(`Extracted title or content for chapter ${chapterIndex} is empty.`);
            }
            return { title, content };
        }

        async function generateChaptersInLoop() {
            const numChapters = parseInt(numChaptersSelect.value, 10);
            const courseTitle = courseNameInput.value;
            for (let i = 1; i <= numChapters; i++) {
                try {
                    aiStatus.textContent = `Generating chapter ${i} of ${numChapters}...`;
                    addChapter();
                    const chapterData = await generateChapter(courseTitle, i, numChapters);
                    const newChapterId = chapterCount;
                    document.getElementById(`chapter-title-${newChapterId}`).value = chapterData.title;
                    editorInstances[newChapterId].setMarkdown(chapterData.content);
                } catch (err) {
                    aiStatus.textContent = `Error generating chapter ${i}. Please try again.\n\nError: ${err.message}`;
                    return;
                }
            }
             aiStatus.textContent = "✅ All chapters have been successfully generated!";
             saveState();
             setTimeout(() => { aiStatus.style.display = 'none'; }, 5000);
        }

        const LOCAL_STORAGE_KEY = "courseCreatorState";
        function saveState() {
            const chapters = [];
            document.querySelectorAll('.chapter').forEach(chapterDiv => {
                const chapterId = chapterDiv.id.split('-')[1];
                const title = document.getElementById(`chapter-title-${chapterId}`).value;
                const content = editorInstances[chapterId] ? editorInstances[chapterId].getMarkdown() : '';
                chapters.push({ title, content });
            });
            const state = {
                courseName: courseNameInput.value,
                courseDesc: courseDescTextarea.value,
                chapters: chapters,
                masterPrompt: masterPromptTextarea.value,
                numChapters: numChaptersSelect.value,
                ollamaModel: activeAIEngine === 'ollama' ? document.getElementById('ollama-model').value : null
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!savedState) {
                addChapter();
                return;
            };
            const state = JSON.parse(savedState);
            courseNameInput.value = state.courseName || '';
            courseDescTextarea.value = state.courseDesc || '';
            masterPromptTextarea.value = state.masterPrompt || '';
            numChaptersSelect.value = state.numChapters || '5';

            if (activeAIEngine === 'ollama' && state.ollamaModel && document.getElementById('ollama-model')) {
                document.getElementById('ollama-model').value = state.ollamaModel;
            }

            chaptersContainer.innerHTML = '';
            Object.keys(editorInstances).forEach(key => delete editorInstances[key]);
            chapterCount = 0;

            if (state.chapters && state.chapters.length > 0) {
                state.chapters.forEach(chapterData => {
                    addChapter();
                    const newChapterId = chapterCount;
                    document.getElementById(`chapter-title-${newChapterId}`).value = chapterData.title;
                    if (editorInstances[newChapterId]) {
                        editorInstances[newChapterId].setMarkdown(chapterData.content);
                    }
                });
            } else {
                addChapter();
            }
        }

        function clearState() {
            if (confirm("Are you sure you want to clear the form and start a new course? All current content will be lost.")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                location.reload();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Defer AI initialization to keep the UI responsive
            setTimeout(() => {
                initializeAI().then(() => {
                    loadState();
                });
            }, 100);

            if (settingsBtn) {
                settingsBtn.onclick = () => {
                    ollamaUrlInput.value = localStorage.getItem('ollamaUrl') || 'http://localhost:11434';
                    settingsModal.style.display = 'block';
                };
            }
            if (closeBtn) {
                closeBtn.onclick = () => { settingsModal.style.display = 'none'; };
            }
            window.onclick = (event) => {
                if (event.target == settingsModal) {
                    settingsModal.style.display = 'none';
                }
            };
            if (saveSettingsBtn) {
                saveSettingsBtn.onclick = () => {
                    localStorage.setItem('ollamaUrl', ollamaUrlInput.value);
                    settingsModal.style.display = 'none';
                    location.reload();
                };
            }
        });
        generateCourseBtn.addEventListener('click', generateCourse);
        document.getElementById('clear-form-btn').addEventListener('click', clearState);
        courseNameInput.addEventListener('input', saveState);
        courseDescTextarea.addEventListener('input', saveState);
        masterPromptTextarea.addEventListener('input', saveState);
        numChaptersSelect.addEventListener('change', saveState);
        chaptersContainer.addEventListener('input', (e) => {
            if (e.target && e.target.classList.contains('chapter-title')) saveState();
        });

        const slugify = (text) => text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
        const addChapter = () => {
            chapterCount++;
            const chapterId = chapterCount;
            const chapterDiv = document.createElement('div');
            chapterDiv.className = 'chapter';
            chapterDiv.id = `chapter-${chapterId}`;
            chapterDiv.innerHTML = `
                <div class="chapter-header">
                    <h3>Chapter ${chapterId}</h3>
                    <button type="button" class="btn btn-danger remove-chapter-btn" data-chapter-id="${chapterId}">Remove</button>
                </div>
                <label for="chapter-title-${chapterId}">Chapter Title</label>
                <input type="text" id="chapter-title-${chapterId}" class="chapter-title" placeholder="e.g., Getting Started" required>
                <label for="editor-${chapterId}">Chapter Content</label>
                <div id="editor-${chapterId}" class="chapter-editor"></div>
            `;
            chaptersContainer.appendChild(chapterDiv);
            editorInstances[chapterId] = new toastui.Editor({
                el: document.querySelector(`#editor-${chapterId}`),
                height: '250px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                toolbarItems: [['heading', 'bold', 'italic', 'strike'], ['hr', 'quote'], ['ul', 'ol', 'task', 'indent', 'outdent'], ['table', 'image', 'link'], ['code', 'codeblock'],['scrollSync']],
                events: { change: () => saveState() }
            });
            chapterDiv.querySelector('.remove-chapter-btn').addEventListener('click', (e) => {
                const id = e.target.dataset.chapterId;
                delete editorInstances[id];
                document.getElementById(`chapter-${id}`).remove();
                saveState();
            });
        };
        addChapterBtn.addEventListener('click', addChapter);

        async function translate(textToTranslate, targetLangName) {
            const prompt = `Translate the following text to ${targetLangName}. Only provide the raw, translated text. Do not include any explanations, introductory phrases, or quotation marks. The text to translate is:\n\n"${textToTranslate}"`;
            try {
                const translatedText = await runAIPrompt(prompt);
                return translatedText.trim() || textToTranslate;
            } catch (err) {
                console.error(`Translation to ${targetLangName} failed:`, err);
                return textToTranslate;
            }
        }

        courseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = courseForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            aiStatus.style.display = 'block';
            aiStatus.textContent = 'Gathering course content...';
            try {
                const courseName = courseNameInput.value;
                const courseDesc = courseDescTextarea.value;
                const selectedLangs = Array.from(document.querySelectorAll('.lang-grid input[type="checkbox"]:checked')).map(cb => cb.value);
                const courseSlug = slugify(courseName);
                if (!courseSlug) { alert('Please enter a valid course name.'); return; }
                if (selectedLangs.length === 0) { alert('Please select at least one language.'); return; }
                const chapters = Array.from(document.querySelectorAll('.chapter')).map((chapterDiv, i) => {
                    const chapterId = chapterDiv.id.split('-')[1];
                    return {
                        title: document.getElementById(`chapter-title-${chapterId}`).value,
                        content: editorInstances[chapterId] ? editorInstances[chapterId].getMarkdown() : '',
                        slug: slugify(document.getElementById(`chapter-title-${chapterId}`).value),
                        number: String(i + 1).padStart(2, '0')
                    };
                });
                if (chapters.length === 0) { alert('Please add at least one chapter.'); return; }
                const zip = new JSZip();
                const courseFolder = zip.folder(courseSlug);
                courseFolder.folder('assets');
                const langCheckboxes = Object.fromEntries(Array.from(document.querySelectorAll('.lang-item input[type="checkbox"]')).map(cb => [cb.value, cb]));
                const nonEnglishLangs = selectedLangs.filter(l => l !== 'en');
                const progress = { completed: 0, total: nonEnglishLangs.length * (2 + chapters.length * 2) };
                if (progress.total > 0) aiStatus.textContent = `Starting translation of ${progress.total} items...`;
                await Promise.all(selectedLangs.map(async (lang) => {
                    const langName = langCheckboxes[lang]?.dataset.name;
                    if (!langName) return;
                    let translatedCourseName = courseName;
                    let translatedCourseDesc = courseDesc;
                    let translatedChapters = chapters;
                    if (lang !== 'en') {
                        const updateProgress = () => {
                            progress.completed++;
                            aiStatus.textContent = `Translating... ${progress.completed} of ${progress.total} items completed.`;
                        };
                        translatedCourseName = await translate(courseName, langName); updateProgress();
                        translatedCourseDesc = await translate(courseDesc, langName); updateProgress();
                        translatedChapters = await Promise.all(chapters.map(async c => {
                            const translatedTitle = await translate(c.title, langName); updateProgress();
                            const translatedContent = await translate(c.content, langName); updateProgress();
                            return { ...c, title: translatedTitle, content: translatedContent };
                        }));
                    }
                    courseFolder.file(`index.${lang}.md`, `---\ndescription: ${translatedCourseDesc}\n---\n\n# ${translatedCourseName}`);
                    translatedChapters.forEach(c => {
                        courseFolder.file(`${c.number}-${c.slug}.${lang}.md`, `# ${c.title}\n\n${c.content}`);
                    });
                }));
                aiStatus.textContent = 'Packaging your course files...';
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                downloadZipLink.href = URL.createObjectURL(zipBlob);
                downloadZipLink.download = `${courseSlug}.zip`;
                downloadSection.style.display = 'block';
                aiStatus.textContent = '✅ Success! Your course files are ready for download.';
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>

</body>
</html>
